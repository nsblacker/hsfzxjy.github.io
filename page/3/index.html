<a id="rocket" href="#top" class="show"></a><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description"/><title>thoughts of hsfzxjy</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/pure-min.css"/><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"/><link rel="stylesheet" type="text/css" href="/css/style.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">thoughts of hsfzxjy</h1><a id="logo" href="/">thoughts of hsfzxjy</a><p class="description"></p><iframe src="https://ghbtns.com/github-btn.html?user=hsfzxjy&amp;type=follow&amp;count=true" frameborder="0" scrolling="0" width="170px" height="20px" class="github-btn"></iframe></div><div id="nav-menu"><a href="/" class="current"><i class="icon-home"> 首页</i></a><a href="/categories/编程/"><i class="icon-code"> 码海拾贝</i></a><a href="/categories/杂感/"><i class="icon-life"> 五味杂感</i></a><a href="/about/"><i class="icon-about"> 我</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h2 class="post-title"><a href="/migrate-to-github.io/">博客迁移至Github.io</a></h2><div class="post-meta">2015年04月17日</div><span data-thread-key="/migrate-to-github.io/" class="ds-thread-count"></span><div class="post-content"><p>###为什么迁出？</p>
<p>话说<strong>SinaAppEngine</strong>真是越来越不像话了：在没有征得我们开发者的同意的情况下擅自把应用总数限制调整为5个（整整少了一半！），还口口声声说是作过调查——</p>
<blockquote>
<p>“大约90%开发者只用5个应用就足够了。”</p>
</blockquote>
<p>同时，增加配额的钱还那么贵，实在担负不起的我只好精简应用数目，以防未来某天应用数不够用。</p>
<p>###为什么选择Github Pages？<br>本人爱好程序，习惯以代码的方式来做事——写文章时也不例外。因此，我需要找到一个支持Markdown的博客平台进行迁移。为此，我经历了很长时间的思想斗争——</p>
<p><strong>新浪、网易 等国内博客平台？</strong></p>
<p>果断否决。这些平台都是面向大众的，只提供富文本编辑器，效率捉急。</p>
<p><strong>博客园？“程序员的网上家园”，总会好一些吧？</strong></p>
<p>虽说最近博客园推出了Markdown编辑器，一切似乎很美好。但是——它——没有即时预览的功能！！这么重要的东西都不加上，写作时就像浑水中摸鱼一样，别提多不爽了。再说了，在博客园上聚集的多是些常工作于Windows平台下的程序员，在“信仰”方面有些合不来（别打我～～）。思考再三，还是否决了。</p>
<p>而事实上，比起公共博客平台，我还是比较喜欢个人博客。一来逼格比较高，可以为将来的交友、面试等活动加分；二来可以随心所欲地自定义样式，使网站完全符合我的Style。</p>
<p>这么一来，似乎就只剩下Github Pages了。</p>
<p>###那么，如何在Github Pages上进行写作？</p>
<p>首先要介绍一下 Github Pages 的架构。先看看 <a href="https://help.github.com/articles/using-jekyll-with-pages/#using-jekyll" target="_blank" rel="external">Github的介绍</a>：</p>
<blockquote>
<h4 id="Using_Jekyll">Using Jekyll</h4><p>Every GitHub Page is run through Jekyll when you push content to a specially named branch within your repository. For User Pages, use the master branch in your username.github.io repository. For Project Pages, use the gh-pages branch in your project’s repository. Because a normal HTML site is also a valid Jekyll site, you don’t have to do anything special to keep your standard HTML files unchanged. Jekyll has thorough documentation that covers its features and usage. Simply start committing Jekyll formatted files and you’ll be using Jekyll in no time.</p>
</blockquote>
<p>可以看得出来，Github Pages使用Jekyll作为后端引擎——这是一个用Ruby写的博客框架。但用户不需要写一行Ruby的代码，只需在名为<strong><username>.github.io</username></strong>的项目下面以一定的目录结构放置markdown文件，Jekyll便会自动生成整个站点。</p>
<p>这里需要注意的是，Jekyll生成的站点是<strong>静态的</strong>，也就是说站点的文件是Jekyll编译好之后存放在服务器端的，而不是接到请求之后才去编译站点，因此站点的访问速度是相当快的——这也是它的优点。</p>
<hr>
<p>我被这种机制深深地震惊了：这是一种我从来没见过的写作方式，无论是从方式上，抑或是从形式上。Jekyll 能让你真正专注于写作，而不是其他一些无谓的东西。     </p>
<p>它把一切无关的东西都摒弃了，这才是真正的极简主义。</p>
<hr>
<p>最初的Jekyll站点是没有样式的。为了不重复发明轮子，我决定使用现成的主题。在网上略一搜索便有了收获：<a href="http://jekyllbootstrap.com/" target="_blank" rel="external">Jekyll Bootstrap</a>。</p>
<p>Bootstrap是我最常用，也是最欣赏的一个前端框架。因此尽管这个主题仍在开发当中，我还是毫不犹豫地选中了它。    </p>
<p>从 <a href="https://github.com/plusjade/jekyll-bootstrap.git" target="_blank" rel="external">Github</a> 上将这个项目 clone 下来，覆盖到hsfzxjy.github.io项目下，理论上，站点就可以运行了。接下来，进行一些样式上的微调就可以了。   </p>
<p>至于评论系统，由于 Github Pages 是静态站点，因此只能使用第三方评论服务。Jekyll 默认的评论服务是Disqus ——一个国外的评论服务站点，但考虑到我在国内，许多人无法使用Facebook，Twitter等社交平台登录评论，我将它替换为了<strong>多说</strong>。具体操作，可以参考 <a href="http://havee.me/internet/2013-07/add-duoshuo-commemt-system-into-jekyll.html" target="_blank" rel="external">这里</a>。</p>
<p>Github Pages上的文章只能在本地编辑，因而需要一个趁手的 Markdown 编辑器。在 Ubuntu 环境下我使用的是 <strong>ReText</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install retext</span><br></pre></td></tr></table></figure></div></div><div class="post"><h2 class="post-title"><a href="/solution-of-network-broken-down-per-20s-under-ubuntu/">Ubuntu 网络每20秒断开重连一次的解决方案</a></h2><div class="post-meta">2015年03月31日</div><span data-thread-key="/solution-of-network-broken-down-per-20s-under-ubuntu/" class="ds-thread-count"></span><div class="post-content"><p>从昨天到现在一直都有这个问题，刚刚突然就解决了，至今不明白原理，在此记录一下：</p>
<blockquote>
<p>在网络设置中取消<strong>需要IPv6完成这个链接</strong>的选项</p>
</blockquote>
</div></div><div class="post"><h2 class="post-title"><a href="/provement-of-Sinusoidal-AC-RMS-calculation-formula/">关于正弦交流电有效值计算公式的证明</a></h2><div class="post-meta">2015年03月04日</div><span data-thread-key="/provement-of-Sinusoidal-AC-RMS-calculation-formula/" class="ds-thread-count"></span><div class="post-content"><h3 id="公式">公式</h3><p>$I = {I_m \over \sqrt{2}}$</p>
<h3 id="证明">证明</h3><p>设 $I = Asin\omega t$，则$I^2 = A^2sin^2\omega t$。</p>
<p>取半个周期进行计算：$${Q \over R} $$<br>$$= \int_0^{T \over 2} I^2tdt$$<br>$$={A^2 \over 2}(t - {sin2\omega t \over 2\omega})|_{0}^{T \over 2}$$<br>$$={A^2T \over 4}$$<br>$$={I^2T \over 2}$$</p>
<p>进而： $I = {A \over \sqrt{2}}$</p>
</div></div><div class="post"><h2 class="post-title"><a href="/HFMUN-reconstruction-3/">【HFMUN重构系列】3. 消息系统</a></h2><div class="post-meta">2015年03月03日</div><span data-thread-key="/HFMUN-reconstruction-3/" class="ds-thread-count"></span><div class="post-content"><blockquote>
<p>一个真正优秀的系统，值得你无数次地去重构。</p>
</blockquote>
<p>消息系统算是网站比较重要的一部分，它承担着将<strong>已发生的事件通知给相关用户</strong>的责任。看似简单，但若想做到DRY，实现起来却很复杂——因为，通知的类型太多了。</p>
<p>这个系统，在三个项目中我实现了三次。三次都使用不同的方法，但三次都不怎么满意。这最后一次，算是比较成功的一次了。</p>
<p>在第一版模联网站中，我采用了一个堪称最糟糕的方案（如图所示）：</p>
<p><img src="/assets/wboard_notifications.jpg" alt="UML"></p>
<p>这个方案最大的缺点：</p>
<ol>
<li><strong>耦合度太高</strong>。如果有一天，又多了一种消息类型，那么就要多加一张表。</li>
<li><strong>查询的难度大</strong>。通常来说我们需要显示所有的消息，从而需要使用JOIN语句进行多表联查——这效率是很低的。</li>
<li><strong>SQL本身就不是面向对象的</strong>。虽说<code>CommentNotification</code>是<code>Notification</code>的子类，可查询时却并不能使用类似<code>Notification.objects.all()</code>一类的语句。在一定程度上可以说：SQL本身就不是面向对象的。</li>
</ol>
<p>而在第二版模联网站中，我采用了<a href="https://docs.djangoproject.com/en/1.7/ref/contrib/contenttypes/" target="_blank" rel="external">泛型</a>（Generic Model Relations）这一技术来实现——这是Django另一大特色：<strong>通过记录对象的类型信息以及唯一标识符，实现了一种可以指向任何表的外键（GenericRelation）</strong>。这种技术存在的目的就是为了<strong>解耦合</strong>，使系统扩展更具灵活性——尽管要损失一些效率，但与架构的“健康”比起来那是微不足道的，无可厚非。</p>
<p>UML图如下：</p>
<p><img src="/assets/hfmun_notices.jpg" alt="UML"></p>
<p>这其中，<code>notice_type</code>的取值决定了<strong><code>url</code>域的作用</strong>：</p>
<ul>
<li><strong><code>link</code></strong>。该消息的<code>url</code>域表示一个指向<code>related_object</code>的地址，应该展示给用户看。</li>
<li><strong><code>invoke</code></strong>。该消息需要在用户确认后执行一个动作。其<code>url</code>域表示需要执行的动作的地址——这里有些TaskQueue的意味。</li>
</ul>
<p>然而，发消息时又应该怎么做呢？如果在所有的地方都来一句：<code>Notice.create(......)</code>，那也太不DRY了吧？</p>
<p>有人说：“懒惰是程序员的天性。”</p>
<p>我赞同，但我还想补充一句：“懒惰更是程序员精简代码的动力。”</p>
<p>于是，我创立了一个类<code>NoticeDispatcher</code>，用于分发消息——其实这一类工具代码在之前的系统中也存在过，只不过这一版本的令我更为满意。</p>
<pre><code><span class="class"><span class="keyword">class</span> <span class="title">NoticeDispatcher</span><span class="params">(object)</span>:</span>

    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, model, default = {})</span>:</span>
        <span class="keyword">if</span> <span class="keyword">not</span> issubclass(model, SendNoticeModelMixin):
            <span class="keyword">raise</span> TypeError(<span class="string">'The `model` must be a subclass of  `SendNoticeModelMixin`.'</span>)
        self.__model = model
        self.__default = {}
        self.__default.update(default)

    <span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(self, *args, **kwargs)</span>:</span>
        klass = Notice

        title = self.__model.generate_title(*args, **kwargs) 
        content = self.__model.generate_content(*args, **kwargs) 
        url = self.__model.generate_url(*args, **kwargs)
        user = self.__model.generate_user(*args, **kwargs)

        valid_keys_set = set(kwargs.iterkeys()) &amp; \
            set(field.name <span class="keyword">for</span> field <span class="keyword">in</span> klass._meta.fields)

        params = deepcopy(self.__default)
        params.update({key: kwargs[key] <span class="keyword">for</span> key <span class="keyword">in</span> valid_keys_set})
        params.update({
            <span class="string">'title'</span>: title,
            <span class="string">'content'</span>: content,
            <span class="string">'url'</span>: url,
        })

        results = []
        <span class="keyword">try</span>:
            iter(user)
        <span class="keyword">except</span>:
            user = (user,)

        <span class="keyword">for</span> _user <span class="keyword">in</span> user:
            params[<span class="string">'user'</span>] = _user
            notice = klass(*args, **params)
            notice.save()
            results.append(notice)

        <span class="keyword">return</span> results
</code></pre><p>我们可以传入一个模型类作为参数从而获得一个<code>NoticeDispatcher</code>对象。这个模型类被要求继承于<code>notices.mixins.SendNoticeModelMixin</code>，以完成一些默认的配置——这是一个抽象基类：</p>
<pre><code><span class="class"><span class="keyword">class</span> <span class="title">SendNoticeModelMixin</span><span class="params">(object)</span>:</span>

<span class="decorator">    @classmethod</span>
    <span class="function"><span class="keyword">def</span> <span class="title">generate_title</span><span class="params">(klass, *args, **kwargs)</span>:</span>
        <span class="keyword">return</span> <span class="string">''</span>

<span class="decorator">    @classmethod</span>
    <span class="function"><span class="keyword">def</span> <span class="title">generate_content</span><span class="params">(klass, *args, **kwargs)</span>:</span>
        <span class="keyword">return</span> <span class="string">''</span>

<span class="decorator">    @classmethod</span>
    <span class="function"><span class="keyword">def</span> <span class="title">generate_url</span><span class="params">(klass, *args, **kwargs)</span>:</span>
        <span class="keyword">return</span> <span class="string">''</span>

<span class="decorator">    @classmethod</span>
    <span class="function"><span class="keyword">def</span> <span class="title">generate_user</span><span class="params">(klass, *args, **kwargs)</span>:</span>
        <span class="keyword">return</span> []
</code></pre><p>做完这一切之后，每当调用<code>notice_dispatcher.send()</code>方法时，<code>NoticeDispatcher</code>会自动调用模型类中的<code>generate_*</code>方法以获取构建消息对象的默认参数。像一些基本不变的内容——如<code>url</code>、<code>title</code>就可以用代码自动生成，进而提高代码复用率。</p>
<p>当然，这个系统仍有一些不够完善的地方，如：</p>
<ul>
<li><code>notice_type</code>为<code>invoke</code>时的逻辑至今尚未实现。</li>
<li>当消息的构建不需要<code>related_object</code>参数时，仍需调用原生的<code>create</code>方法，非常麻烦。</li>
<li><code>related_object</code>参数仍需手动传入，有些不干净——最好就是能在<code>SendNoticeModelMixin</code>上实现<code>send</code>方法，很多啰嗦的代码便又可以省略掉了。</li>
</ul>
<p>以上问题，或是由于没有需求，或是由于懒惰（- -!），没有来得及去实现。但愿能在下一次改进时解决。</p>
<p>总而言之呢，事情正在似乎在朝着好的方面发展。</p>
</div></div><div class="post"><h2 class="post-title"><a href="/ten-years/">十年</a></h2><div class="post-meta">2015年03月03日</div><span data-thread-key="/ten-years/" class="ds-thread-count"></span><div class="post-content"><p>再一次站在这里，我却发现早已没有了熟悉的感觉。一切都是那样陌生：长年累月的雨水冲刷，使原本灰色的墙面变得愈加晦暗，有几处墙皮脱落了，酷似一张布满皱纹的老脸；门前，野草肆意地疯长着，没过了缩在墙角的那根水管——记忆中它一直在渗水，却不知何时被修好了，只留下了一圈丑陋的青苔，像是对这十年光阴的一个标注。</p>
<p>这里的一切，就像是被人遗弃了。四周站着的那一圈高楼，无时无刻不在表达着对这角隅的不屑——就像长辈们对待无知的孩童一样。<br>而事实上，这里比周围的一切都要年长。</p>
<p>时光上溯十年，那时，我居住于此。那时，还没有周围这一切。</p>
<p>曾记得，在不远处的那块菜地，我和小伙伴趟过泥水，猫着腰在捕捉小鱼小虾。柔软的泥土记录这我们的足迹，竹架上的蔬果聆听着我们的欢笑，就连那不知名的虫儿，也哼起歌为我们助兴。</p>
<p>曾记得，在屋后的那片小树林，上演过一次又一次的“探险之旅”。不畏阴暗，不惧神秘，只求抵达尽头时那种大汗淋漓的快意。</p>
<p>曾记得，在楼顶的天台，我第一次仰望星空。夏夜的风吹起架子上的藤蔓，吹拂着我的脸庞。和着如水的月光，四周的一切就像仙境般梦幻。</p>
<p>这里，有着我童年的所有回忆。</p>
<p>可如今，这一切都像是未曾发生过。这里，也未曾记得。</p>
<p>十年，很长，长得足以让一个人，去遗忘一个地方。</p>
<p>再一次遇见他，没有太多的喜悦，只是相视一笑，随即，便陷入了沉默。</p>
<p>比起上一次相遇，他又有了一些变化，整个人显得更加成熟了。但与此同时，一种未知的像雾一样的却在我们中间弥散开来，凝固着空气，窒息着心灵。</p>
<p>我竭力搜寻着话题，想要打破这恼人的尴尬，但却徒劳无功——真的没有共同语言了，毕竟在新的环境里，我们都有了新的爱好。</p>
<p>真是一个让人迷惑的时代——在这里，共有着美好的回忆，却也无法维系十年的友情。</p>
<p>在那人生的上古时期，他，是我最好的朋友，一起逃过课，在小学边上的山坡尽情地疯玩；一起偷过钱，忐忑地在小商店购买垂涎已久的零食。那些年和他，一玩能玩一天，一聊能聊一宿。我们有过争吵，而更多时候，我们亲如弟兄。</p>
<p>记忆中的那些画面，每一张笑脸，每一滴眼泪，都是那样真诚。</p>
<p>只是，曾经的旧知己，最终还是变不到老友。</p>
<p>十年，很长，长得足以让一个人，去疏远另一个人。</p>
<p>十年，真的很长。承载着过去的回忆，有欢笑，有泪水——就像是人那短暂一生的缩影。</p>
<p>人生又能有几个十年？无从得知。</p>
<p>因此，每一个十年都弥足珍贵；每一个十年，都要用心去珍惜。</p>
</div></div><div class="post"><h2 class="post-title"><a href="/kill-processes-under-ubuntu/">ubuntu杀死进程</a></h2><div class="post-meta">2015年03月02日</div><span data-thread-key="/kill-processes-under-ubuntu/" class="ds-thread-count"></span><div class="post-content"><pre><code>ps <span class="operator">-e</span> <span class="comment">#查看进程列表</span>
sudo <span class="built_in">kill</span> &lt;pid&gt;
</code></pre></div></div><div class="post"><h2 class="post-title"><a href="/HFMUN-reconstruction-2/">【HFMUN重构系列】2. 用户系统</a></h2><div class="post-meta">2015年01月28日</div><span data-thread-key="/HFMUN-reconstruction-2/" class="ds-thread-count"></span><div class="post-content"><blockquote>
<p>现在，我比任何时候都要有主见。</p>
</blockquote>
<p>这是这次重构过程中我最想说的一句话了。</p>
<p>毋庸置疑，Django是一个十分优秀的Web框架：高效的开发模式，完备的应用集成，以及最重要的一点——具有完全自由的扩展能力——这是Django的灵魂所在。但是无知，通常会束缚了一个人的探索欲望与创新能力，让其变得胆怯、变得懒惰。一年前我的遭遇就很好地印证了这一点。</p>
<p>对于一个网站而言，用户永远是最重要的元素。没有了用户，网站做得再好也只能被放在角落腐烂，与死尸无异。这样看来，打造一个完美的用户系统就显得十分必要了。</p>
<p>Django为我们提供了一个优秀的用户系统，它位于<code>django.contrib.auth</code>——想必Djangoers都对它很熟悉了。<code>auth</code>应用是专门为用户管理打造的一个应用，它提供了以下功能：</p>
<ul>
<li>一个用户模型（User）。这是<code>auth</code>框架的核心所在，用于存储用户信息，包括 用户名、密码、邮箱等内容。该模型可被替换也可被拓展，具有良好的可塑性。</li>
<li>一个权限系统（Permission）。这部分为实现访问控制提供了可能。一个<code>Permission</code>对应一个关于<code>Model</code>的操作，默认有<code>add</code>、<code>change</code>、<code>delete</code>三种。值得一提的是，在版本<code>1.7</code>之前，Django并不提供更改默认权限的能力，即每个<code>Model</code>都会固定拥有以上三种权限。我个人觉得这种做法不太好，并不是所有的模型都需要这种功能划分。更何况权限限制被应用在Django的每一个角落，如果想让一个模型完全开放，就要多敲许多不必要的代码。如今Django1.7改进了这一点，这使得模型更加简洁了。</li>
<li>用户分组的功能（Groups）。一个<code>Group</code>可以拥有多个<code>Permission</code>，一个用户可以选择加入一个<code>Group</code>，并会自动拥有还<code>Group</code>的权限。这一设计简化了用户管理的操作，同时也让用户系统的更有层次。</li>
</ul>
<p>在这里，我想说的是关于扩展<code>User</code>模型的一些技巧。</p>
<p>一年之前，由于对Django的不了解，我不敢对它的内部实现大动干戈。而事实上，没有什么东西是绝对完美的，即便是集众智于一身的开源框架也是如此。诚然，<code>auth</code>框架是不错，但在某些特定的应用场景，它便显得心有余而力不足了。因此，我希望能在<code>User</code>模型上附带一些额外的信息。</p>
<p>百度一下，我找到了一个被广为流传的方法：<code>Profile</code>模式。也就是说，额外定义一个<code>Profile</code>模型和<code>User</code>模型建立一一对应的关系，用于储存额外信息。我清楚地记得，几乎是每一篇博客都在介绍这种方法，于是乎我毫不犹豫地就采纳了。现在想一想，这其实是一个十分糟糕的方案。它有如下缺点：</p>
<ul>
<li><strong>操作麻烦。</strong>每次访问额外信息，都要先询问是否存在<code>Profile</code>对象，如果不存在得先创建。然后再调用<code>user_object.profile</code>来访问信息。同时，这种方案对表单不友好，因为用户信息是被分开储存在两个表中的。</li>
<li><strong>效率低下。</strong>每次访问额外信息，先是用<code>IF EXISTS</code>判断是否存在，再用<code>INNER JOIN</code>将主信息和次信息从数据库中取出，一共需要两条SQL语句。更何况，<code>INNER JOIN</code>指令是公认的效率低下的指令。</li>
</ul>
<p>因此，在这次重构中我采用了一种截然不同的做法：直接重写<code>User</code>模型。这里的灵感来自<a href="https://docs.djangoproject.com/en/1.7/topics/auth/customizing/#auth-custom-user" target="_blank" rel="external">Django官方文档</a>：</p>
<blockquote>
<p>Some kinds of projects may have authentication requirements for which Django’s built-in User model is not always appropriate. For instance, on some sites it makes more sense to use an email address as your identification token instead of a username.</p>
<p>Django allows you to override the default User model by providing a value for the AUTH_USER_MODEL setting that references a custom model:</p>
<pre><code><span class="setting">AUTH_USER_MODEL = <span class="value"><span class="string">'myapp.MyUser'</span></span></span>
</code></pre></blockquote>
<p>听起来不错，既方便实现起来又简单。于是我重写了我的<code>accounts</code>应用：</p>
<pre><code><span class="comment">#encoding=utf8</span>
<span class="string">"""
    事实上这里许多实现都模仿自`django.contrib.auth.models.User`，毕竟我只是要存储一些额外信息而已。
"""</span>
<span class="keyword">from</span> django.core <span class="keyword">import</span> validators
<span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> AbstractBaseUser, PermissionsMixin, BaseUserManager
<span class="keyword">from</span> django.utils.translation <span class="keyword">import</span> ugettext_lazy <span class="keyword">as</span> _
<span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone
<span class="keyword">from</span> django.db <span class="keyword">import</span> models

<span class="class"><span class="keyword">class</span> <span class="title">UserManager</span><span class="params">(BaseUserManager)</span>:</span>

    <span class="function"><span class="keyword">def</span> <span class="title">_create_user</span><span class="params">(self, username, password,
                     is_staff, is_superuser, **extra_fields)</span>:</span>
        <span class="string">"""
        Creates and saves a User with the given username, email and password.
        """</span>
        now = timezone.now()
        <span class="keyword">if</span> <span class="keyword">not</span> username:
            <span class="keyword">raise</span> ValueError(<span class="string">'The given username must be set'</span>)
        user = self.model(username=username,
                          is_staff=is_staff, is_active=<span class="keyword">True</span>,
                          is_superuser=is_superuser, last_login=now,
                          date_joined=now, **extra_fields)
        user.set_password(password)
        user.save(using=self._db)
        <span class="keyword">return</span> user

    <span class="function"><span class="keyword">def</span> <span class="title">create_user</span><span class="params">(self, username, password=None, **extra_fields)</span>:</span>
        <span class="keyword">return</span> self._create_user(username, password, <span class="keyword">False</span>, <span class="keyword">False</span>,
                                 **extra_fields)

    <span class="function"><span class="keyword">def</span> <span class="title">create_superuser</span><span class="params">(self, username, password, **extra_fields)</span>:</span>
        <span class="keyword">return</span> self._create_user(username, password, <span class="keyword">True</span>, <span class="keyword">True</span>,
                                 **extra_fields)

<span class="comment"># 这里的`AbstractBaseUser`是用户模型的基类，由于原生的`User`模型中有一些字段并不是我想要的，因此我需要从上一个抽象类继承。</span>
<span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(AbstractBaseUser, PermissionsMixin)</span>:</span>

    username = models.CharField(_(<span class="string">'username'</span>), max_length=<span class="number">30</span>, unique=<span class="keyword">True</span>,
        help_text=_(<span class="string">'Required. 30 characters or fewer. Letters, digits and '</span>
                    <span class="string">'@/./+/-/_ only.'</span>),
        validators=[
            validators.RegexValidator(<span class="string">r'^[\w.@+-]+$'</span>, _(<span class="string">'Enter a valid username.'</span>), <span class="string">'invalid'</span>)
        ])

    <span class="comment"># 用户描述</span>
    description = models.TextField()

    <span class="comment"># 昵称</span>
    nickname = models.CharField(_(<span class="string">'nickname'</span>),
        max_length=<span class="number">30</span>, unique=<span class="keyword">True</span>,
        help_text=_(<span class="string">'Required. 30 characters or fewer.'</span>),
        )

    <span class="comment"># 好友关系</span>
    friends = models.ManyToManyField(
        <span class="string">'self'</span>,
        verbose_name=_(<span class="string">'friends'</span>),
        blank=<span class="keyword">True</span>,
        related_name=<span class="string">'+'</span>
        )

    <span class="comment">#================以下是原有的字段==================</span>
    is_staff = models.BooleanField(_(<span class="string">'staff status'</span>), default=<span class="keyword">False</span>,
        help_text=_(<span class="string">'Designates whether the user can log into this admin '</span>
                    <span class="string">'site.'</span>))
    is_active = models.BooleanField(_(<span class="string">'active'</span>), default=<span class="keyword">True</span>,
        help_text=_(<span class="string">'Designates whether this user should be treated as '</span>
                    <span class="string">'active. Unselect this instead of deleteing accounts.'</span>))
    date_joined = models.DateTimeField(_(<span class="string">'date joined'</span>), auto_now_add=<span class="keyword">True</span>)

    USERNAME_FIELD = <span class="string">'username'</span>
    objects = UserManager()

    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span>
        verbose_name = _(<span class="string">'user'</span>)
        verbose_name_plural = _(<span class="string">'users'</span>)

    <span class="function"><span class="keyword">def</span> <span class="title">get_full_name</span><span class="params">(self)</span>:</span>
        <span class="keyword">return</span> self.nickname

    <span class="function"><span class="keyword">def</span> <span class="title">get_short_name</span><span class="params">(self)</span>:</span>
        <span class="keyword">return</span> self.nickname
</code></pre><p>以及<code>settings.py</code>文件：</p>
<pre><code><span class="preprocessor">#...</span>
AUTH_USER_MODEL = <span class="string">'accounts.User'</span>
<span class="preprocessor">#...</span>
</code></pre><p>为了让admin框架同步支持我们的新<code>User</code>模型，还需要对<code>admin.py</code>以及<code>forms.py</code>进行相应的修改，实际上就是把新加入的字段写进相应的类即可，在这里我就不贴代码了。</p>
<p>做完这一切，一个念头忽然从我脑海中闪过：对于一些第三方应用，如果它们直接引用了<code>django.contrib.auth.models.User</code>，那该怎么办呢？我的<code>User</code>模型会生效吗？</p>
<p>这让我感到不安，因为重构的一大原则便是：不得改变外部接口的调用情况。如果这一改动使得整个网站都崩溃了，那就得不偿失了。可庆幸的是，这样的事情并没有发生。</p>
<p>这不禁让我感到好奇：django是怎么做到这一点的？</p>
<p>翻看<code>django.contrib.auth.models</code>，我发现了如下一句代码：</p>
<pre><code><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(AbstractUser)</span>:</span>
    <span class="string">"""
    Users within the Django authentication system are represented by this
    model.

    Username, password and email are required. Other fields are optional.
    """</span>
    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span><span class="params">(AbstractUser.Meta)</span>:</span>
        swappable = <span class="string">'AUTH_USER_MODEL'</span>
</code></pre><p>查找<a href="https://docs.djangoproject.com/en/1.8/ref/models/fields/#django.db.models.ForeignKey.swappable" target="_blank" rel="external">Django文档</a>，原来这是Django1.7的一个新特性：</p>
<blockquote>
<p><strong>ForeignKey.swappable</strong></p>
<p>Controls the migration framework’s reaction if this ForeignKey is pointing at a swappable model. If it is True - the default - then if the ForeignKey is pointing at a model which matches the current value of settings.AUTH_USER_MODEL (or another swappable model setting) the relationship will be stored in the migration using a reference to the setting, not to the model directly.</p>
<p>You only want to override this to be False if you are sure your model should always point towards the swapped-in model - for example, if it is a profile model designed specifically for your custom user model.</p>
<p>Setting it to False does not mean you can reference a swappable model even if it is swapped out - False just means that the migrations made with this ForeignKey will always reference the exact model you specify (so it will fail hard if the user tries to run with a User model you don’t support, for example).</p>
<p>If in doubt, leave it to its default of True.</p>
</blockquote>
<p>这个特性可以使指向这个模型的ForeignKey自动被替换成<code>Meta.swappable</code>的内容，实现模型的可替换能力。这是一个巧妙的设计。</p>
<p>重构后的<code>accounts</code>应用，逻辑变得更加清晰，也使我不再纠结于冗长的恼人的<code>Profile</code>调用。</p>
<p>这，是一个美妙的起点。</p>
</div></div><div class="post"><h2 class="post-title"><a href="/HFMUN-reconstruction-1/">【HFMUN重构系列】1. Django1.7</a></h2><div class="post-meta">2015年01月27日</div><span data-thread-key="/HFMUN-reconstruction-1/" class="ds-thread-count"></span><div class="post-content"><p>有人说：</p>
<blockquote>
<p>“软件更新的速度永远也比不上客户使用的速度。”</p>
</blockquote>
<p>的确，网络世界真是一个日新月异的地方，甚至作为开发者的我也能真切地感受到这一点。记得2013年初，Django最高的版本号才是1.5.5。一年之后，已经变成1.7了（事实上，应该是1.7.3，两个月的时间让我又落后了0.3个版本）。比起1.5.x，Django1.7多了如下的新特性：</p>
<ul>
<li>Migrations，即实时同步数据库。在此之前，如果要对Model的表结构进行改动，要么自己用MySQL的<code>ALTER TABLE</code>语句，要么就删除整个数据库再<code>syncdb</code>（大家可能很惊讶，由于本人较懒，因此常常会做出这样“鲁莽”的操作，反正是在调试- -）。这给开发带来了不少的麻烦。尽管不少博客都说——在解读需求时期就要定好表结构。可对于我，这点实在是比较难办到，总会有一些考虑不周的地方。</li>
<li>Custom lookups，即自定义查找规则。我们常常会用到QuerySet的查找语句<code>User.objects.filter(id__lt=2)</code>等等。但如果要某一天我要实现自定义规则，如MySQL的全文搜索，又该怎么做呢？在1.7之前，Django并没有提供相应的接口，只能通过嵌入Raw SQL来实现。如今，1.7的这个特性让大家眼前一亮，同时也使数据库查找变得更加灵活。</li>
<li>App Configurations，即关于应用的自定义配置。就我个人看来，这里主要时方便了Admin的应用名显示。在1.7版本之前，我们无法设定应用在Admin中显示的名字，只能让那些格格不入的英文名显示在管理界面中——这也是我不让Admin投入实际应用的一个原因。如今，通过配置<code>AppConfig</code>，我们可以轻易地实现这一点。</li>
</ul>
<p>在HFMUN2.0中我用到的新特性大概就是这些，它们给应用开发带来了愉悦的体验。但可恶的是：<strong>SAE并不同步更新Django。</strong>如今，那里的Django仍然停留在版本1.5。</p>
<p>于是，我只能将新鲜出炉的Django1.7放在网站的目录下，一同传上SAE。</p>
<p>起初，我是将Django打包成Zip文件发在<code>site_packages/</code>目录下，因为我隐约记得Python是支持直接导入Zip文件的。但尝试了许多次，都说“找不到Django”。迫不得已，只好将Django解压出来再上传——这花费了我不少的时间（哦！中国的上传速度！）。</p>
<p>接下来便是Django的配置了。先将<code>config.yaml</code>修改成这样：</p>
<pre><code><span class="attribute">name</span>: <span class="string">hfmun</span>
<span class="attribute">version</span>: <span class="string">1</span>
</code></pre><p>既然我们已经不用SAE自带的Django了，就应该把依赖关系删除，以免导入其默认的Django。</p>
<p>接着修改<code>index.wsgi</code>：</p>
<pre><code><span class="comment">#...</span>
<span class="keyword">import</span> sys
<span class="keyword">from</span> site_packages <span class="keyword">import</span> django 
sys.modules[<span class="string">'django'</span>] = django
<span class="comment">#...</span>
</code></pre><p>由于<code>index.wsgi</code>是第一个被执行的文件，在此处把Django先导入可以保证之后每次使用的Django都是自己上传的那个版本。<br>至此，新版本Django就可以使用了。</p>
<p><em>ps：据测试，这样配置的网站大约会比普通的网站慢几十毫秒，大概是自己的Django需要启动时间。不过比起新功能，这点损耗是微不足道的。</em></p>
</div></div><div class="post"><h2 class="post-title"><a href="/HFMUN-reconstruction-0/">【HFMUN重构系列】0. 前言</a></h2><div class="post-meta">2015年01月27日</div><span data-thread-key="/HFMUN-reconstruction-0/" class="ds-thread-count"></span><div class="post-content"><p>这是2014年初我接到的一个项目：给模拟联合国建立一个网站，实现文章发布以及在线聊天的功能，供在3月初的华附模联大会使用。</p>
<p>这是我人生中做的第一个网站，也是在这时，我组建了第一支自己的开发团队——尽管，只有两个人；尽管，我们都才高一。至于他们是怎么找到我的，那一刻，我记得十分清楚——那是2013年12月的某天，一个晚自习的课间，阿三突然走进来大喊了一声：“我们班有谁会做网站的？”那时候的我，刚刚接触web编程。我记得，我毫不犹豫地就答应了。这一句回答，改变了我之后一年多的生活。其中，有收获，同时也失去了一些东西——但我不后悔。这一年多的生活，在别人看来我似乎是在固执地溯流行船，逆着大家公认的“好的方向”前进，可我觉得这一切都是值得的。一年来，我收获的不只是技术，还有团队协作能力、与客户交涉的能力、许多解决未知问题的方法，以及最重要的一点——快乐。现在回想起来：如果当初我没有选择这一条路，也许我会通过一些“传统”的努力获得一些“传统”的荣誉，甚至没有了高考的负担，这固然不错，但同时我也会失去上一句话中提到的那些东西——一些在书本中学不到的珍宝，这些都是要通过实践来感知。更何况——每个人都应该拥有属于自己的生活。</p>
<p>我又想起了黄老师那句话：</p>
<blockquote>
<p>“希望你不要随波逐流。”</p>
</blockquote>
<p>言归正传。我先简单概括一下这个系统的情况。这是搭建在SinaAppEngine上的一个网站，使用Python+Django1.7+MySQL+Bootstrap3进行开发。去年的版本做的实在是有些匆忙，在投入使用前一天才草草收尾，没有经过QA测试就投入使用了——或者说我们请客户当了QA(T_T)。幸好客户比较温柔，不像传说中段子里提到的<strong>可怕的甲方</strong>，或许是因为这是第一版，又或许是碍于同学情面。</p>
<p>那次的前端做得实在是太挫了：每一个界面元素都是照搬Bootstrap的组件，Bootstrap没有的便用其中一种或几种组合（Panel搭建的超大评论框就这么诞生了…），我们自己只写了少得可怜的几行css——事实上就凭着当年那菜鸟级别的css水平，我们也不敢乱改。另外一个令我们头疼的是IE兼容性问题（EVIL！）——这还是一个用户发现的：bootstrap在IE8-下全乱了。我只得陪着笑乞求他们换用Chrome，别提有多尴尬了。</p>
<p>问题还不止这些。2013年初，正是新浪云的Channel服务进行公测的时候。Channel服务是新浪云自主开发的一个提供客户端实时推送的服务，可应用于网络聊天室等实时性要求较高的网站中。有了这一技术，我才有能力搭建会议聊天系统。但这毕竟是Alpha版本，难免有些Bug。在调试时，光是和新浪客服交涉就花了我不少的时间。可在实际应用时它还是出了一些毛病，甚至在会议最后半天时它干脆直接无法使用了（π.π）。</p>
<blockquote>
<p>凡事都是要走出第一步的，无论是成功或是失败。</p>
</blockquote>
<p>时光荏苒，转眼间一年又过去了。从14年12月开始我又重新启动了这一项目。比起上一次，尽管上次的网站做基础，尽管我有了更多的时间，可用户的需求也更加苛刻了。截至目前，1月27日，重构已经几乎完成了。在这里，我将记下这两个月的重构工程中发生的点点滴滴。</p>
<p>附：<a href="http://hfmun.sinaapp.com/" target="_blank" rel="external">华附模拟联合国官网</a></p>
</div></div><div class="post"><h2 class="post-title"><a href="/sublime-text-2-installation-under-ubuntu/">Ubuntu安装Sublime 2</a></h2><div class="post-meta">2014年12月29日</div><span data-thread-key="/sublime-text-2-installation-under-ubuntu/" class="ds-thread-count"></span><div class="post-content"><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:webupd8team/sublime-text-<span class="number">2</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install sublime-text-<span class="number">2</span></span><br></pre></td></tr></table></figure>
</div></div><div class="page-navigator"><a href="/page/2/" class="pre">上一页</a><a href="/page/4/" class="next">下一页</a></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><div id="search"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://hsfzxjy.github.io"></form></div></div><div class="widget"><div class="widget-title">导航<ul><li><a href="/archives/"> <i class="icon-archives"> 归档</i></a></li><li><a href="/works/"> <i class="icon-works"> 个人作品</i></a></li><li><a href="/atom.xml"> <i class="icon-rss"> 订阅</i></a></li></ul></div></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/学习/">学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数学/">数学</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂感/">杂感</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/转载文章/">转载文章</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/随手记/">随手记</a></li></ul></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/总结/" style="font-size: 15px;">总结</a> <a href="/tags/Delphi/" style="font-size: 15px;">Delphi</a> <a href="/tags/杂谈/" style="font-size: 15px;">杂谈</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/generator/" style="font-size: 15px;">generator</a> <a href="/tags/coroutine/" style="font-size: 15px;">coroutine</a> <a href="/tags/杂感/" style="font-size: 15px;">杂感</a> <a href="/tags/数学/" style="font-size: 15px;">数学</a> <a href="/tags/计算几何/" style="font-size: 15px;">计算几何</a> <a href="/tags/向量/" style="font-size: 15px;">向量</a> <a href="/tags/随想/" style="font-size: 15px;">随想</a> <a href="/tags/javascript/" style="font-size: 15px;">javascript</a> <a href="/tags/DIY/" style="font-size: 15px;">DIY</a> <a href="/tags/字符串模板/" style="font-size: 15px;">字符串模板</a> <a href="/tags/正则表达式/" style="font-size: 15px;">正则表达式</a> <a href="/tags/Meta-Classes/" style="font-size: 15px;">Meta Classes</a> <a href="/tags/黑魔法/" style="font-size: 15px;">黑魔法</a> <a href="/tags/元编程/" style="font-size: 15px;">元编程</a> <a href="/tags/诗/" style="font-size: 15px;">诗</a> <a href="/tags/作文/" style="font-size: 15px;">作文</a> <a href="/tags/家书/" style="font-size: 15px;">家书</a> <a href="/tags/成人礼/" style="font-size: 15px;">成人礼</a> <a href="/tags/产品/" style="font-size: 15px;">产品</a> <a href="/tags/编程/" style="font-size: 15px;">编程</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/web设计/" style="font-size: 15px;">web设计</a> <a href="/tags/wisecity/" style="font-size: 15px;">wisecity</a> <a href="/tags/前端自动化测试/" style="font-size: 15px;">前端自动化测试</a> <a href="/tags/OOP/" style="font-size: 15px;">OOP</a> <a href="/tags/前端/" style="font-size: 15px;">前端</a> <a href="/tags/单元测试/" style="font-size: 15px;">单元测试</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/不经意间的感动/" style="font-size: 15px;">不经意间的感动</a> <a href="/tags/HFMUN重构系列/" style="font-size: 15px;">HFMUN重构系列</a> <a href="/tags/化学/" style="font-size: 15px;">化学</a> <a href="/tags/ubuntu/" style="font-size: 15px;">ubuntu</a> <a href="/tags/apt-get/" style="font-size: 15px;">apt-get</a> <a href="/tags/物理/" style="font-size: 15px;">物理</a> <a href="/tags/创新作文大赛/" style="font-size: 15px;">创新作文大赛</a> <a href="/tags/Sublime/" style="font-size: 15px;">Sublime</a> <a href="/tags/转载/" style="font-size: 15px;">转载</a> <a href="/tags/字体/" style="font-size: 15px;">字体</a> <a href="/tags/百题大过关/" style="font-size: 15px;">百题大过关</a> <a href="/tags/逆袭/" style="font-size: 15px;">逆袭</a> <a href="/tags/MySql/" style="font-size: 15px;">MySql</a> <a href="/tags/NOIP2014/" style="font-size: 15px;">NOIP2014</a> <a href="/tags/信息学竞赛/" style="font-size: 15px;">信息学竞赛</a> <a href="/tags/北大金秋营/" style="font-size: 15px;">北大金秋营</a> <a href="/tags/树状数组/" style="font-size: 15px;">树状数组</a> <a href="/tags/LCA/" style="font-size: 15px;">LCA</a> <a href="/tags/归并排序/" style="font-size: 15px;">归并排序</a> <a href="/tags/逆序对/" style="font-size: 15px;">逆序对</a> <a href="/tags/最小生成树/" style="font-size: 15px;">最小生成树</a> <a href="/tags/数论/" style="font-size: 15px;">数论</a> <a href="/tags/数列/" style="font-size: 15px;">数列</a> <a href="/tags/高精度/" style="font-size: 15px;">高精度</a> <a href="/tags/UVa/" style="font-size: 15px;">UVa</a> <a href="/tags/Pascal/" style="font-size: 15px;">Pascal</a> <a href="/tags/搜索/" style="font-size: 15px;">搜索</a> <a href="/tags/剪枝/" style="font-size: 15px;">剪枝</a> <a href="/tags/浮点数/" style="font-size: 15px;">浮点数</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/游记/" style="font-size: 15px;">游记</a> <a href="/tags/win32/" style="font-size: 15px;">win32</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/why-I-choose-to-climb-over-the-wall/">为什么我要翻墙</a></li><li class="post-list-item"><a class="post-list-link" href="/python-generator-coroutine/">Python “黑魔法” 之 Generator Coroutines</a></li><li class="post-list-item"><a class="post-list-link" href="/the-simplest-way-to-find-out-if-two-segments-are-intersected/">数学美 之 判断线段相交的最简方法</a></li><li class="post-list-item"><a class="post-list-link" href="/thinking-in-the-day-before-lunar-new-year-of-2016/">除夕杂感</a></li><li class="post-list-item"><a class="post-list-link" href="/a-simple-javascript-template-language/">17 行代码实现的简易 Javascript 字符串模板</a></li><li class="post-list-item"><a class="post-list-link" href="/meta-class-in-python/">Python “黑魔法” 之 Meta Classes</a></li><li class="post-list-item"><a class="post-list-link" href="/poems/">诗集</a></li><li class="post-list-item"><a class="post-list-link" href="/life-needs-discovery/">生活，需要被“发现”</a></li><li class="post-list-item"><a class="post-list-link" href="/letter-to-parents/">家书·十八岁成人礼</a></li><li class="post-list-item"><a class="post-list-link" href="/hobby-or-needs/">炫技？还是需求？</a></li></ul></div><div class="widget"><div class="comments-title">最近评论</div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div></div></div></div><div id="footer">© <a href="/" rel="nofollow">thoughts of hsfzxjy.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></body><script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/totop.js" type="text/javascript"></script>
<script src="/js/adjust-wechat.js" type="text/javascript"></script><script src="/js/fancybox.pack.js" type="text/javascript"></script><link rel="stylesheet" href="/css/jquery.fancybox.css" type="text/css"><script>$(document).ready(function() {
    $('img').each(function() {
        if ($(this).parent().hasClass('fancybox')) return;
        if ($(this).hasClass('nofancybox')) return;
        var alt = this.alt;
        if (alt) $(this).after('<span class="caption">' + alt + '</span>');
        $(this).wrap('<a href="' + ($(this).attr('data-src') == null ? this.src : $(this).attr('data-src')) + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
        $(this).attr('rel', 'article');
    });
});</script><script>$(document).ready(function() {
    $("a[href$='.jpg'],a[href$='.png'],a[href$='.gif']").attr('rel', 'gallery').fancybox({
     helpers : {
     title: { type: 'inside'}
     }
 });
});
</script><script>var duoshuoQuery = {short_name:'hsfzxjy'};
(function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0]
                || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$']]},
    jax: ["input/TeX","output/HTML-CSS"]
});
</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></html>