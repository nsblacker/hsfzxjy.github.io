
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>主页</title>
    
    <script src="/assets/themes/bootstrap-3/bootstrap/js/jquery.min.js"></script>
    <meta name="author" content="Jinyi Xie">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <!-- Bootstrap styles -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bootstrap.min.css" rel="stylesheet" defer async="true">
    <!-- Optional theme -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/assets/themes/bootstrap-3/pygments.css">
    
    <!-- Custom styles -->
    <link href="/assets/themes/bootstrap-3/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div id="wrap">
      <nav class="navbar navbar-default navbar-inverse" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#jb-navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">hsfzxjy</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="jb-navbar-collapse">
          <ul class="nav navbar-nav">
            
            
            


  
    
      
      	
      	<li><a href="/archieve.html">归档</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">分类</a></li>
      	
      
    
  
    
  
    
      
      	
      	<li><a href="/pages.html">页面</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">标签</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/about/">联系我</a></li>
      	
      
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  



          </ul>
        </div><!-- /.navbar-collapse -->
      </nav>

      <div class="container" id="main-container">
        <a href="https://github.com/hsfzxjy" target="_blank" class="hidden-xs">
          <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png">
        </a>
        
<div class="page-header">
  <h1 class="post-title">
         
         <small class="tagline">不忌讳空山无人，不害怕遥望星辰</small>
  </h1>
</div>

<div class="row">
  <div class="col-xs-12 post-content">
    
<link rel="stylesheet" type="text/css" href="/assets/themes//bootstrap-3/css/index.css?body=1">
<div class="posts">
  
    <article class="post-content">
        <header class="text-center">
            <h1 class="post-title">
                <a href="/that-starry-night/">那一年，我们望向星空</a>
            </h1>
            <p class="time">08 May 2015</p>
        </header>
        <section class="content">
            <blockquote>
<p>还记得吗     </p>

<p>那年夏天     </p>

<p>最灿烂、最寂寞的星空</p>
</blockquote>

<p>其实，比这部电影更出名的，是五月天的那首《星空》，一首我十分熟悉的歌。每当那旋律响起，我总有些淡淡的惆怅：夜空下，尽管繁星璀璨，却无法触及；生活中，尽管万分努力，无奈梦想却悄悄陨落——世上的一切，似乎总要与人作对。然而一曲过后，当那歇斯底里的旋律如晨雾渐渐散去，悔恨、无奈与痛苦，也随之沉淀下来，一切又恢复了平静——就像是伫立于人生的黄昏中，回忆着年少时那数不清的美梦。</p>

<p>而，直到最近我才得知：这只是一首片尾曲，原来还有一部与它同名的电影。</p>

<p>《星空》。</p>

<p>没有浮华的特效，没有肉麻的对白。那一年，一个少年，一位少女，一段耐人寻味的经历。</p>

<p>“我们一起去看星空吧。”</p>

<p>那一晚，在城市的光与影中，在混凝土森林间，小美轻轻地问小杰，没有过多的犹豫。</p>

<p>也许，小美的遭遇是值得同情的：尽管家境殷实，父母却常常争吵不休。每每置身于这偌大的房子里，却都如同处在异域时空，唯有那陈旧的回忆才能给她些许慰藉。相似的经历，让少女认识了小杰——那个在圣诞夜吹笛子的男孩，那个和她一起做教室布置的男孩。</p>

<p>腾空而起的火车，云雾缭绕的阿里山，雨夜的旧教堂，爷爷的小木屋……一场梦幻般的冒险正在进行着。当然，还有那一夜的星空，灿烂得令人终生难忘。</p>

<p>可惜，小美却病倒了，旅途也不得不要结束了。</p>

<p>但生活还得继续。从山里回来，小杰便匆匆地走了，甚至，还没来得及说再见；小美的父母还是离婚了，尽管，小美并不希望。曾经的美好，如松动的拼图般叮当散落下来，露出背后灰色的现实——就像那梦中的场景，残酷，毫不留情。</p>

<p>只是，那片星空，给了她些许慰藉。</p>

<p>随着时光流逝，曾经的不解与难舍，终究还是要散去——而留下的，仅有回忆。这，也是歌曲《星空》所要表达的。</p>

<p>曾几何时，我们每个人心中，都有一片属于自己的星空——在年少时，在我们的上古时代，当我们依旧单纯。</p>

<p>总有一段幻想，让我们流连忘返，就像驰骋于梵高画卷中的铁皮列车；总有一段冒险，让我们刻骨铭心，正如山林间那次凶险的跋涉；而总有一个人，值得我们用一生去回忆。</p>

<p>当残酷的现实还未闯入梦境，当尘世的烦扰还没纠缠于心，那时，那个无法无天的自己，才是真正快乐的。</p>

<p>人，是脆弱的。也许，生活的磨难能使我们变得懦弱，岁月的流逝会让我们失去梦想，世间的一切都和自己过不去。</p>

<p>但，人也可以很坚强。需要的并不多，只是那一片铭记在心的星空。</p>

        </section>
        
          <ul class="tag_box inline">
            <li><i class="glyphicon glyphicon-open"></i></li>
            
            


  
     
    	<li><a href="/categories.html#杂感-ref">
    		杂感 <span>8</span>
    	</a></li>
    
  


          </ul>
          

        
          <ul class="tag_box inline">
            <li><i class="glyphicon glyphicon-tags"></i></li>
            
            


  
     
    	<li><a href="/tags.html#不经意间的感动-ref">不经意间的感动 <span>5</span></a></li>
    
  



          </ul>
         
    </article>
  
    <article class="post-content">
        <header class="text-center">
            <h1 class="post-title">
                <a href="/hfmun-reconstruction-4/">【HFMUN重构系列】4. Restful API 框架</a>
            </h1>
            <p class="time">23 Apr 2015</p>
        </header>
        <section class="content">
            <h2><strong>0x01 什么是REST</strong></h2>

<p>“REST”这个词，也许会在许多场合上出现，但并不是每个人都理解它的意思。在维基百科中，它被定义为：</p>

<blockquote>
<p><strong>Representational State Transfer (REST)</strong> is a software architecture style consisting of guidelines and best practices for creating scalable web services. REST is a coordinated set of constraints applied to the design of components in a distributed hypermedia system that can lead to a more performant and maintainable architecture.    <cite>—— From <a href="http://en.wikipedia.org/wiki/Representational_state_transfer">Wikipedia</a></cite></p>
</blockquote>

<p>也就是说：<strong>REST，它不是一种技术，也不是一种标准，而是一种网络资源访问模式，一种编程哲学</strong>。狭义上来说，REST指的是这样的设计思想：</p>

<ol>
<li>每一个 URI 代表一种资源</li>
<li>客户端和服务器之间，传递这种资源的某种表现层</li>
<li>客户端通过五个 HTTP 动词（GET，POST，PUT，PATCH，DELETE），对服务器端资源进行操作，实现&quot;表现层状态转化&quot;（State Transfer）</li>
</ol>

<p>狭义的 REST 范式是基于 B/S 架构，并使用 HTTP 协议进行数据交互。比起古老而笨重的 SOAP 等架构，这种模式更加轻便、直观，使网络资源的访问变得简洁、优雅，也更加符合当今 Web 开发的需求。</p>

<h2><strong>0x02 如何正确使用 REST</strong></h2>

<p>正如上面所说，REST 是基于 HTTP 协议的。它用 URI 来定义资源，并用 HTTP 请求来操作资源。然而，并不是说使用了 HTTP 协议即可称之为 REST——真正意义上的 REST，有自己的一套准则。也正是这套准则，才使得 REST 简洁、优雅。</p>

<h3>REST 是语义的</h3>

<p>语义的（Semantic）是指：<strong>资源的 URI 或是资源的访问必须是有意义的，符合或尽量符合自然语言的规范</strong>。</p>

<p>举个例子：如果我要访问订单的列表，那么一个良好的 URI 定义应该是这样的：</p>
<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">GET</span> <span class="nn">/orders/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</code></pre></div>
<p>资源的 URI 通常由名词组成，这也正符合自然语言的规范——表达一个物体，人们使用名词。</p>

<p>如果要精确定位某一个资源，通常需要进一步限制资源：</p>
<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">GET</span> <span class="nn">/orders/1/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</code></pre></div>
<p>或是：</p>
<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">GET</span> <span class="nn">/orders/current/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</code></pre></div>
<p>甚至，可以表示资源的从属关系：</p>
<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">GET</span> <span class="nn">/users/current/orders/1/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</code></pre></div>
<p>这就像在和服务器对话一样：<strong>“请给我当前用户的第一份订单”</strong>。</p>

<p>而一些与资源本身无关的信息，比如列表的最大数目，可以放到 URI Params 中：</p>
<div class="highlight"><pre><code class="language-HTTP" data-lang="HTTP"><span class="nf">GET</span> <span class="nn">/orders/?limit=20</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</code></pre></div>
<p>HTTP协议中的动词（Verbs），通常用来描述对资源的操作。每一种动词都有它自己的意义：</p>

<ul>
<li><strong>GET</strong>——获取资源</li>
<li><strong>POST</strong>——建立一个新的资源</li>
<li><strong>PUT</strong>——修改一个资源，必须提交该资源的所有内容</li>
<li><strong>PATCH</strong>——修改一个资源，可以只提交该资源的一部分内容</li>
<li><strong>DELETE</strong>——删除一个资源</li>
</ul>

<h3>REST 是多样的</h3>

<p>至于返回的数据，服务器端可以提供多种格式供客户端选择，如 JSON、XML、YAML等等，通常用格式的缩写作为尾缀：</p>
<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">GET</span> <span class="nn">/orders.json/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</code></pre></div>
<h3>REST 是健壮的</h3>

<p>倘若用户请求的资源不存在或是提交的数据不合规范，服务器必须以<strong>HTTP状态码</strong>的方式通知客户端。常用的状态码有：</p>

<ul>
<li><strong>400</strong> 请求参数有误</li>
<li><strong>401</strong> 用户未登录</li>
<li><strong>403</strong> 没有权限</li>
<li><strong>404</strong> 资源找不到</li>
</ul>

<h2><strong>0x03 django 中的 REST</strong></h2>

<p>像 REST 这么高大上的东西，早就有人对它进行了实现，这便是：<a href="http://www.django-rest-framework.org/">Django Rest Framework</a>。基本的用法可以参见官网。</p>

<p>成熟的框架并不是最好的，只有适合自己的才是。在使用过程中我遇到了一系列的问题，并以自己的方式解决了他们。</p>

<h3>ViewSet 的路由不够 D.R.Y.</h3>

<p><code>ViewSet</code> 是 <code>rest_framework</code>中一个十分有创意的地方。它将 CRUD 操作集中到了一个类中，提高了代码的复用性。然而，每一个 <code>ViewSet</code> 都需要 定义一个 <code>Router</code> 进行 URL 路由，这很麻烦。于是乎我便想：</p>

<blockquote>
<p>要是能让它自动感知<code>ViewSet</code>的存在并自动为其定义路由，就像<code>django</code>中的<code>Models</code>一样，那该多好啊</p>
</blockquote>

<p>于是，我仿照<code>django.apps.registry</code>，写了一个能在启东时探知一个 app 中固定内容的 <code>app_cache</code> 模块：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># app_cache/core.py</span>

<span class="kn">from</span> <span class="nn">django.utils.importlib</span> <span class="kn">import</span> <span class="n">import_module</span>
<span class="kn">from</span> <span class="nn">django.utils.module_loading</span> <span class="kn">import</span> <span class="n">module_has_submodule</span>
<span class="kn">from</span> <span class="nn">django.apps</span> <span class="kn">import</span> <span class="n">apps</span>

<span class="k">class</span> <span class="nc">AppCache</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Inherit this class and override the fields below, then import and instantiate</span>
<span class="sd">    the subclass at AppConfig.ready method.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">module_name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">object_name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">default_object</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__module_name</span> <span class="o">=</span> <span class="s">&#39;.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_name</span>

    <span class="k">def</span> <span class="nf">get_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_modules</span><span class="p">():</span>
            <span class="k">yield</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_object</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">app_config</span> <span class="ow">in</span> <span class="n">apps</span><span class="o">.</span><span class="n">get_app_configs</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">module_has_submodule</span><span class="p">(</span><span class="n">app_config</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_name</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">yield</span> <span class="n">import_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__module_name</span><span class="p">,</span> <span class="n">app_config</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>
<p>同时新建一个叫<code>api</code>的 app，在<code>api/core.py</code>中实现自动寻找<code>ViewSet</code>：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">app_cache</span> <span class="kn">import</span> <span class="n">AppCache</span>

<span class="k">class</span> <span class="nc">APICache</span><span class="p">(</span><span class="n">AppCache</span><span class="p">):</span>

    <span class="n">default_object</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">object_name</span> <span class="o">=</span> <span class="s">&#39;routers&#39;</span>
    <span class="n">module_name</span> <span class="o">=</span> <span class="s">&#39;routers&#39;</span>

    <span class="k">def</span> <span class="nf">get_routers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_objects</span><span class="p">():</span>
            <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

<span class="n">cache</span> <span class="o">=</span> <span class="n">APICache</span><span class="p">()</span>
</code></pre></div>
<p>在<code>api/urls.py</code>中实现自动路由：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># api/urls.py</span>

<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span><span class="p">,</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">include</span>

<span class="kn">from</span> <span class="nn">rest_framework.routers</span> <span class="kn">import</span> <span class="n">DefaultRouter</span>
<span class="kn">from</span> <span class="nn">rest_framework.viewsets</span> <span class="kn">import</span> <span class="n">ViewSetMixin</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>

<span class="kn">from</span> <span class="nn">.core</span> <span class="kn">import</span> <span class="n">cache</span>

<span class="n">extra_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">router</span> <span class="o">=</span> <span class="n">DefaultRouter</span><span class="p">()</span>
<span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_routers</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">extra_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ViewSetMixin</span><span class="p">):</span>
        <span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">APIView</span><span class="p">):</span>
        <span class="n">extra_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">as_view</span><span class="p">()))</span>

<span class="n">extra_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">(</span><span class="s">r&#39;^&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">urls</span><span class="p">)))</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^auth/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">&#39;rest_framework.urls&#39;</span><span class="p">,</span> <span class="n">namespace</span> <span class="o">=</span> <span class="s">&#39;rest_framework&#39;</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^root/$&#39;</span><span class="p">,</span> <span class="s">&#39;api.views.root&#39;</span><span class="p">,),</span>
    <span class="o">*</span><span class="n">extra_list</span>
<span class="p">)</span>
</code></pre></div>
<p>之后，只需在每个 app 中定义一个<code>routers.py</code>，并定义<code>routers</code>变量即可实现 <code>ViewSet</code> 的自动路由，例如：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">.views</span> <span class="kn">import</span> <span class="n">UserAPIViewSet</span>

<span class="n">routers</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s">r&#39;users&#39;</span><span class="p">,</span> <span class="n">UserAPIViewSet</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div>
<p>非常方便。</p>

<h3>分页机制的进一步改进</h3>

<p><code>rest_framework</code>提供了一个数据分页的机制：透过<code>limit</code>和<code>page</code>这两个 URL 参数可以实现数据的分页以及页码索引。</p>

<p>但这个功能在客户要求的应用场景中似乎并不太实用。毕竟，模联大会是一次节奏紧张的活动，网站并发量大，内容更新频繁，若应用传统分页的构想，可能会出现翻页时浏览到重复内容的情况。除此之外，这样的架构不利于实现<strong>瀑布流式</strong>的界面，因为瀑布流式要求待加载的数据与已加载的数据完美地无缝接合，而这一点对于传统分页架构来说也是力不从心。</p>

<p>曾记得，<a href="http://open.weibo.com/wiki/2/statuses/public_timeline">新浪微博 API </a>中好像有类似的实现：凡是返回一个列表的 API ，返回数据中都会有<code>previous_cursor</code>和<code>next_cursor</code>两个参数，通过这两个参数，开发者可以获取上一份或下一份的数据。受此启发，我决定增强一下<code>rest_framework</code>的分页机制。</p>

<blockquote>
<h4>想法</h4>

<ol>
<li>可在 API 的请求中传入参数 <code>sinceid</code> 或是 <code>beforeid</code>，表示获取<code>id</code>紧跟着<code>&lt;sinceid&gt;</code>或是<code>&lt;beforeid&gt;</code>的一批数据。</li>
<li>当 API 返回值是一个列表时，返回数据中增加两个域<code>since</code>和<code>before</code>，分别是指向上一批数据及下一批数据的 URL。</li>
</ol>
</blockquote>

<p>改动得不多，于是我便直接在别人的代码里开刀了。</p>

<p>首先在<code>rest_framework/</code>中增加一个<code>custom_filters.py</code>，用于存放自定义的过滤器：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django_filters</span> <span class="kn">import</span> <span class="n">FilterSet</span><span class="p">,</span> <span class="n">NumberFilter</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;get_timeline_filter&#39;</span><span class="p">,</span> <span class="s">&#39;is_timeline_filter&#39;</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">TimelineFilter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">is_timeline_filter</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">TimelineFilter</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_timeline_filter</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">base_filter_class</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    工厂方法，给不同的模型类指派不同的过滤器</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">base_filter_class</span><span class="p">:</span>
        <span class="n">base_filter_class</span> <span class="o">=</span> <span class="n">FilterSet</span>

    <span class="k">class</span> <span class="nc">_TimelineFilter</span><span class="p">(</span><span class="n">base_filter_class</span><span class="p">,</span> <span class="n">TimelineFilter</span><span class="p">):</span>

        <span class="n">sinceid</span> <span class="o">=</span> <span class="n">NumberFilter</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;pk&#39;</span><span class="p">,</span> <span class="n">lookup_type</span> <span class="o">=</span> <span class="s">&#39;gt&#39;</span><span class="p">)</span>
        <span class="n">beforeid</span> <span class="o">=</span> <span class="n">NumberFilter</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;pk&#39;</span><span class="p">,</span> <span class="n">lookup_type</span> <span class="o">=</span> <span class="s">&#39;lt&#39;</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">base_filter_class</span><span class="p">,</span><span class="s">&#39;Meta&#39;</span><span class="p">,</span><span class="nb">object</span><span class="p">)):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model_class</span>

    <span class="k">return</span> <span class="n">_TimelineFilter</span>
</code></pre></div>
<p>修改<code>rest_framework/generics.py</code>，为<code>GenericAPIView</code>加入<code>hack_filter_class()</code>方法，放入上面定义的过滤器；再修改<code>get_filter_backends()</code>方法，使其生效：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">.custom_filters</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c">#...</span>

<span class="k">class</span> <span class="nc">GenericAPIView</span><span class="p">(</span><span class="n">views</span><span class="o">.</span><span class="n">APIView</span><span class="p">):</span>

    <span class="c">#...</span>

    <span class="k">def</span> <span class="nf">hack_filter_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">filter_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;filter_class&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_timeline_filter</span><span class="p">(</span><span class="n">filter_class</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter_class</span> <span class="o">=</span> <span class="n">get_timeline_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">filter_class</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_filter_backends</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the list of filter backends that this view requires.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_timeline</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hack_filter_class</span><span class="p">()</span>

        <span class="n">filter_backends</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_backends</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filter_backends</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_backend</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s">&#39;The `filter_backend` attribute and `FILTER_BACKEND` setting &#39;</span>
                <span class="s">&#39;are due to be deprecated in favor of a `filter_backends` &#39;</span>
                <span class="s">&#39;attribute and `DEFAULT_FILTER_BACKENDS` setting, that take &#39;</span>
                <span class="s">&#39;a *list* of filter backend classes.&#39;</span><span class="p">,</span>
                <span class="ne">PendingDeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">filter_backends</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_backend</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">filter_backends</span>
</code></pre></div>
<p>最后再修改<code>rest_framework/pagination.py</code>，这个模块的功能是给<code>Serializer</code>加入分页机制中一些必要的域，如<code>next</code>和<code>previous</code>：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># ...</span>
<span class="n">sinceid_field</span> <span class="o">=</span> <span class="s">&#39;sinceid&#39;</span>
<span class="n">beforeid_field</span> <span class="o">=</span> <span class="s">&#39;beforeid&#39;</span>

<span class="k">class</span> <span class="nc">SinceIdField</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">to_native</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span><span class="o">.</span><span class="n">object_list</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">object_list</span><span class="p">[:]</span>
            <span class="n">sinceid</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">object_list</span><span class="p">)</span> 
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;request&#39;</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">request</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">build_absolute_uri</span><span class="p">()</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">replace_query_params</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span>
            <span class="n">sinceid_field</span><span class="p">:</span> <span class="n">sinceid</span><span class="p">,</span>
            <span class="n">beforeid_field</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
        <span class="p">})</span>

<span class="k">class</span> <span class="nc">BeforeIdField</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">to_native</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span><span class="o">.</span><span class="n">object_list</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">object_list</span><span class="p">[:]</span>
            <span class="n">beforeid</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">object_list</span><span class="p">)</span> 
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;request&#39;</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">request</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">build_absolute_uri</span><span class="p">()</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">replace_query_params</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span>
            <span class="n">beforeid_field</span><span class="p">:</span> <span class="n">beforeid</span><span class="p">,</span>
            <span class="n">sinceid_field</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
        <span class="p">})</span>

<span class="c"># ...</span>

<span class="k">class</span> <span class="nc">PaginationSerializer</span><span class="p">(</span><span class="n">BasePaginationSerializer</span><span class="p">):</span>

    <span class="n">count</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&#39;paginator.count&#39;</span><span class="p">)</span>
    <span class="nb">next</span> <span class="o">=</span> <span class="n">NextPageField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
    <span class="n">previous</span> <span class="o">=</span> <span class="n">PreviousPageField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
    <span class="n">before</span> <span class="o">=</span> <span class="n">BeforeIdField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
    <span class="n">since</span> <span class="o">=</span> <span class="n">SinceIdField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
</code></pre></div>
<p>完成了——在没有修改一处业务逻辑代码的前提下，我增强了分页机制。</p>

<h2><strong>0x04 前端接口</strong></h2>

<p>终于来到前端部分了。</p>

        </section>
        
          <ul class="tag_box inline">
            <li><i class="glyphicon glyphicon-open"></i></li>
            
            


  
     
    	<li><a href="/categories.html#hfmun重构系列-ref">
    		hfmun重构系列 <span>5</span>
    	</a></li>
    
  


          </ul>
          

         
    </article>
  
    <article class="post-content">
        <header class="text-center">
            <h1 class="post-title">
                <a href="/chemistry-impurity/">高中化学常用除杂方法</a>
            </h1>
            <p class="time">22 Apr 2015</p>
        </header>
        <section class="content">
            <h2>0x00 规律</h2>

<ol>
<li>要除去弱酸性气体中混有的强酸性气体杂质，我们常选用弱酸性气体溶于水后形成的饱和盐溶液。若弱酸性气体溶于水后为一元酸，则用该酸形成的饱和正盐溶液。若为二元弱酸，则为该酸形成的饱和酸式盐，如$Cl_2$混有$HCl$气体，用饱和食盐水净化吸收，如$CO_2$中混有$HCl$、$SO_2$用饱和$NaHCO_3$溶液净化吸收。 </li>
<li>要除去非还原性气体中的还原性气体，应选用反应前后均具固体的具有氧化性的物质。如$CO_2$中混有的$CO$,用灼热的$CuO$除去。 </li>
<li>要除去非氧化性气体中的氧化性气体，应选用反应前后均是固体的具有还原性的物质。如$CO_2$中混有的$O_2$，用灼热的铜网除去。 </li>
<li>要除去中性气体中的酸性气体，用强碱溶液或碱石灰吸收。如：$CO$中的混有的$CO_2$用$NaOH$溶液吸收除去。 </li>
<li>要除去中性气体中的碱性气体(一般是$NH_3$),用浓硫酸吸收。如：N2中混有的$NH_3$，用浓硫酸吸收除去。 </li>
<li>要除去饱和烃中的烯烃、炔烃气体，用溴水吸收，如：$CH_4$中混有$C_2H_4$、$C_2H_2$，用溴水可吸收除去。 </li>
<li>要除去有机烃中混有的无机酸性气体可用$NaOH$溶液和碱石灰吸收而除去。 </li>
<li>还有些个别方法，就应该个别记住了。如NO中混有的少量$NO_2$气体，可用水吸收转化而除去，$C_2H_4$中混有的$H_2S$,除可用规律4的方法除去外，还可用$CuSO_4$或$Pb(NO_3)_2$等溶液除去。</li>
</ol>

<h2>0x01 常见除杂</h2>

<ol>
<li>N2($O_2$) ——灼热的铜丝 2Cu+$O_2$=2 $CuO$<br></li>
<li>$CO_2$($H_2S$) ——用饱和$NaHCO_3$溶液 $NaHCO_3$+$H_2S$=NaHS+$H_2O$+$CO_2$↑<br></li>
<li>$CO_2$($CO$) ——灼热的氧化铜 $CuO$+$CO$=Cu+$CO_2$<br></li>
<li>$CO_2$($HCl$) ——用饱和$NaHCO_3$溶液 $NaHCO_3$+$HCl$=$NaCl$+$H_2O$+$CO_2$↑<br></li>
<li>$H_2S$($HCl$) —— 用饱和NaHS溶液 NaHS+$HCl$=$NaCl$+$H_2S$<br></li>
<li>$SO_2$($HCl$) ——用饱和NaHSO3溶液 NaHSO3+$HCl$=$NaCl$+$H_2O$+$SO_2$↑<br></li>
<li>$Cl_2$($HCl$) ——用饱和食盐水，$HCl$易溶而$Cl_2$不溶<br></li>
<li><p>$MnO_2$(碳粉)——</p>

<ol>
<li>将混合物在氧气中点燃 C+$O_2$=$CO_2$ 或者</li>
<li>通入灼热的氧化钙 C+$CaO$=Ca+$CO_2$↑(条件:高温) 或者</li>
<li>通入灼热的氧化铁 3C+2 $Fe_2O_3$=3CO2↑+ 4Fe<br></li>
</ol></li>
<li><p>碳粉($MnO_2$)——加浓盐酸$MnO_2$+4$HCl$(浓)=$MnCl_2$+$Cl_2$↑+2$H_2O$  </p></li>
<li><p>C($CuO$)——加稀盐酸$CuO$+2$HCl$=$CuCl_2$+$H_2O$  </p></li>
<li><p>$Al_2O_3$($Fe_2O_3$) ——这个一步是无法除去的啊！  </p>

<ol>
<li><strong>方法一</strong>： 

<ol>
<li>将固体混合物溶于过量的氢氧化钠溶液，过滤除去氧化铁，留下滤液。 $Al_2O_3$+2$OH^{-}$=2$AlO^{2-}$+$H_2O$ </li>
<li>向滤液中通入过量的$CO_2$，过滤得到$Al(OH)_3$,加热使$Al(OH)_3$分解。 $AlO^{2-}$+2$H_2O$+$CO_2$=$Al(OH)_3$+$HCO_3^-$ 2$Al(OH)_3$=$Al_2O_3$+3$H_2O$<br></li>
</ol></li>
<li><p><strong>方法二</strong>：     </p>

<ol>
<li> 将固体混合物溶于过量的盐酸溶液中，是混合物完全溶解。 $Al_2O_3$+6$H^+$=2$Al^{3+}$+3$H_2O$ $Fe_2O_3$+6$H^+$=2$Fe^{3+}$+3$H_2O$<br></li>
<li>加入过量$NaOH$溶液,过滤除去沉淀$Fe(OH)_3$, $Fe^{3+}$+3$OH^{-}$=$Fe(OH)_3$ $Al^{3+}$+4$OH^{-}$=$AlO^{2-}$+2$H_2O$<br></li>
<li>向滤液中通入过量的$CO_2$，过滤得到$Al(OH)_3$,加热使$Al(OH)_3$分解。$AlO^{2-}$+2$H_2O$+$CO_2$=$Al(OH)_3$+$HCO_3^-$ 2$Al(OH)_3$=$Al_2O_3$+3$H_2O$如果是反一下就直接加氢氧化钠啊！<br></li>
</ol></li>
</ol></li>
<li><p>SIO2($Al_2O_3$) ——加入稀盐酸$Al_2O_3$ + 6$HCl$ = 2AlCl3 + 3$H_2O$  </p></li>
<li><p>$FeCl_3$($FeCl_2$) ——通入氯气$Cl_2$+2 $FeCl_2$=2 $FeCl_3$   </p></li>
<li><p>$FeCl_2$($FeCl_3$) ——加入铁Cu+2 $FeCl_3$=$CuCl_2$+$FeCl_2$  </p></li>
<li><p>$NaCl$($NH_4Cl$) ——固体的话直接加热$NH_4Cl$=$NH_3$+$HCl$  </p></li>
<li><p>C2H6($C_2H_4$) ——通入溴水或者酸性高锰酸钾溶液$CH_2=CH_2$+$Br_2$→$CH_2Br-CH_2Br$  </p></li>
<li><p>溴苯($Br_2$) ——加入氢氧化钠2 $NaOH$+$Br_2$=$NaBr$+$NaBrO$+$H_2O$分液  </p></li>
<li><p>硝基苯($NO_2$) ——加入氢氧化钠2 $NO_2$ + 2 $NaOH$ = $NaNO_2$ + $NaNO_3$ +$H_2O$分液  </p></li>
<li><p>甲苯(苯酚)——加入氢氧化钠$Ph-OH$+$NaOH$=$Ph-ONa$+$H_2O$分液  </p></li>
<li><p>乙醛(乙酸)——加饱和碳酸钠2$CH_3COOH$ + $Na_2CO_3$ = 2$CH_3COONa$+ $H_2O$ + $CO_2$蒸馏</p></li>
<li><p>乙醇(水)——加氧化钙蒸馏  </p></li>
<li><p>乙酸乙酯(乙酸)——饱和碳酸钠溶液2$CH_3COOH$ + $Na_2CO_3$ = 2$CH_3COONa$+ $H_2O$ + $CO_2$分液  </p></li>
<li><p>肥皂(甘油)——加入$NaCl$，发生盐析进行过滤  </p></li>
<li><p>葡萄糖(淀粉)——加入稀硫酸水解$C_6H_{10}O_5$(淀粉)+$H_2O$=$C_6H_{12}O_6$(葡萄糖)  </p></li>
<li><p>溴乙烷(乙醇)——用水，分液 </p></li>
</ol>

        </section>
        
          <ul class="tag_box inline">
            <li><i class="glyphicon glyphicon-open"></i></li>
            
            


  
     
    	<li><a href="/categories.html#化学-ref">
    		化学 <span>2</span>
    	</a></li>
    
  


          </ul>
          

         
    </article>
  
    <article class="post-content">
        <header class="text-center">
            <h1 class="post-title">
                <a href="/html5-media-test/">初试HTML5</a>
            </h1>
            <p class="time">19 Apr 2015</p>
        </header>
        <section class="content">
            <h2>audio &amp; video</h2>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;video</span> <span class="na">src=</span><span class="s">&quot;http://www.w3school.com.cn/i/movie.ogg&quot;</span> <span class="na">controls=</span><span class="s">&quot;controls&quot;</span><span class="nt">&gt;</span>
您的浏览器不支持 video 标签。
<span class="nt">&lt;/video&gt;</span>
<span class="nt">&lt;audio</span> <span class="na">src=</span><span class="s">&quot;http://www.w3school.com.cn/i/horse.ogg&quot;</span> <span class="na">controls=</span><span class="s">&quot;controls&quot;</span><span class="nt">&gt;</span>
Your browser does not support the audio element.
<span class="nt">&lt;/audio&gt;</span>
</code></pre></div>
<div class="center-example">
    <video src="http://www.w3school.com.cn/i/movie.ogg" controls="controls">
    您的浏览器不支持 video 标签。
    </video>
    <audio src="http://www.w3school.com.cn/i/horse.ogg" controls="controls">
    Your browser does not support the audio element.
    </audio>
</div>

<h2>canvas</h2>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;canvas</span> <span class="na">id=</span><span class="s">&quot;myCanvas&quot;</span><span class="nt">&gt;</span>
    your browser does not support the canvas tag 
<span class="nt">&lt;/canvas&gt;</span>

<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
    <span class="kd">var</span> <span class="nx">canvas</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;myCanvas&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">ctx</span><span class="o">=</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span><span class="o">=</span><span class="s1">&#39;#FF0000&#39;</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">grd</span><span class="o">=</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">createLinearGradient</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">175</span><span class="p">,</span><span class="mi">50</span><span class="p">);</span>
    <span class="nx">grd</span><span class="p">.</span><span class="nx">addColorStop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;#FF0000&quot;</span><span class="p">);</span>
    <span class="nx">grd</span><span class="p">.</span><span class="nx">addColorStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;#00FF00&quot;</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span><span class="o">=</span><span class="nx">grd</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">175</span><span class="p">,</span><span class="mi">50</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div>
<div class="center-example">
    <canvas id="myCanvas" class="align-center">
        your browser does not support the canvas tag 
    </canvas>
</div>

<script type="text/javascript">
    var canvas=document.getElementById('myCanvas');
    var ctx=canvas.getContext('2d');
    ctx.fillStyle='#FF0000';
    ctx.fillRect(0,0,80,100);
    var grd=ctx.createLinearGradient(0,0,175,50);
    grd.addColorStop(0,"#FF0000");
    grd.addColorStop(1,"#00FF00");
    ctx.fillStyle=grd;
    ctx.fillRect(0,100,175,50);
</script>

<h2>LocalStorage</h2>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">$input</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#localstorage-input&quot;</span><span class="p">),</span> <span class="nx">key</span> <span class="o">=</span> <span class="s1">&#39;my-key&#39;</span><span class="p">;</span>
<span class="nx">$input</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">key</span><span class="p">));</span>
<span class="nx">$input</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change, keyup&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">$input</span><span class="p">.</span><span class="nx">val</span><span class="p">());</span>
<span class="p">})</span>
</code></pre></div>
<div class="example">
    <div class="form-group">
        <label class="control-label">这个文本框中的内容不会改变：</label>
        <input id="localstorage-input" type="text" class="form-control">
    </div>
</div>

<script type="text/javascript">
    var $input = $("#localstorage-input"), key = 'my-key';
    $input.val(localStorage.getItem(key));
    $input.on('change, keyup', function () {
        localStorage.setItem(key, $input.val());
    })
</script>

        </section>
        
          <ul class="tag_box inline">
            <li><i class="glyphicon glyphicon-open"></i></li>
            
            


  
     
    	<li><a href="/categories.html#编程-ref">
    		编程 <span>36</span>
    	</a></li>
     
    	<li><a href="/categories.html#html5-ref">
    		html5 <span>1</span>
    	</a></li>
    
  


          </ul>
          

         
    </article>
  
    <article class="post-content">
        <header class="text-center">
            <h1 class="post-title">
                <a href="/backup-apt-get/">如何备份apt-get已安装的软件列表？</a>
            </h1>
            <p class="time">19 Apr 2015</p>
        </header>
        <section class="content">
            <p><code>apt-get</code>是 ubuntu 下管理软件包的一个工具，实用简单，功能强大。平时若要安装或卸载软件包，只需轻敲一条指令即可。每一台ubuntu上，都安装着数以千百计的软件包——或是内核模块，或是工作、娱乐所需的软件，在它们的支持下，工作着这个开放的操作系统。</p>

<p>但，如果有一天，系统需要被重装——或是无可救药了，抑或是购置了新的设备，问题来了：</p>

<blockquote>
<p>如何将现有电脑上的软件包迁移至新的系统呢？</p>
</blockquote>

<p>很简单。</p>

<p>首先，将原有的软件列表导出：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo dpkg --get-selections  &gt; app-backup-list.lst
</code></pre></div>
<p>最好是设置一个定时任务，每隔一段时间就保存一次列表，并且要保存到一个独立的分区。以免某天系统真的坏了。</p>

<p>接下来便是导入了：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo dpkg --set-selections &lt; app-backup-list.lst
sudo apt-get -y update
sudo apt-get dselect-upgrade
</code></pre></div>
<p>至于软件源的备份，只需将<code>/etc/apt/sources.list</code>文件复制过去即可。</p>

        </section>
        
          <ul class="tag_box inline">
            <li><i class="glyphicon glyphicon-open"></i></li>
            
            


  
     
    	<li><a href="/categories.html#ubuntu-ref">
    		ubuntu <span>9</span>
    	</a></li>
     
    	<li><a href="/categories.html#apt-get-ref">
    		apt-get <span>1</span>
    	</a></li>
    
  


          </ul>
          

        
          <ul class="tag_box inline">
            <li><i class="glyphicon glyphicon-tags"></i></li>
            
            


  
     
    	<li><a href="/tags.html#ubuntu-ref">ubuntu <span>3</span></a></li>
     
    	<li><a href="/tags.html#apt-get-ref">apt-get <span>1</span></a></li>
    
  



          </ul>
         
    </article>
  
</div>

<ul class="pager">
  
    <li class="previous">
      <a class="prev" href="/page3/">&larr; 上一页</a>
    </li>
  
  
  <li class="next">
    <a class="next" href="/index.html">下一页 &rarr;</a>
  </li>
  
</ul>

  </div>
</div>


      </div>

    </div>

    <div id="footer">
      <div class="container">
        <p class="text-center">
          Powered by Jekyll. Hosted at Github. <br>
          Copyright &copy; hsfzxjy.
        </p>
      </div>
    </div>

    <script type="text/javascript">
    var duoshuoQuery = {short_name:"hsfzxjy"};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
    </script>
    <script src="/assets/themes/bootstrap-3/bootstrap/js/bootstrap.min.js" defer async="true"></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX", "output/HTML-CSS"],
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
          processEscapes: true
        },
        "HTML-CSS": { availableFonts: ["TeX"] }
      });
    </script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default" defer async="true"></script>
  </body>
</html>
