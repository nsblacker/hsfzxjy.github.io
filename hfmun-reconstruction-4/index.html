<a id="rocket" href="#top" class="show"></a><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description"/><title>【HFMUN重构系列】4. Restful API 框架 | hsfzxjy</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/pure-min.css"/><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"/><link rel="stylesheet" type="text/css" href="/css/style.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">【HFMUN重构系列】4. Restful API 框架</h1><a id="logo" href="/">hsfzxjy</a><p class="description">不忌讳空山无人，不害怕遥望星辰</p><iframe src="https://ghbtns.com/github-btn.html?user=hsfzxjy&amp;type=follow&amp;count=true" frameborder="0" scrolling="0" width="170px" height="20px" class="github-btn"></iframe></div><div id="nav-menu"><a href="/" class="current"><i class="icon-home"> 首页</i></a><a href="/categories/编程/"><i class="icon-code"> 码海拾贝</i></a><a href="/categories/杂感/"><i class="icon-life"> 五味杂感</i></a><a href="/about/"><i class="icon-about"> 我</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">【HFMUN重构系列】4. Restful API 框架</h1><div class="post-meta">2015-04-23 | <span class="categories">分类于<a href="/categories/编程/">编程</a></span></div><span data-thread-key="/hfmun-reconstruction-4/" class="ds-thread-count"></span><div class="post-content"><h2 id="0x01_什么是REST"><strong>0x01 什么是REST</strong></h2><p>“REST”这个词，也许会在许多场合上出现，但并不是每个人都理解它的意思。在维基百科中，它被定义为：</p>
<blockquote>
<p><strong>Representational State Transfer (REST)</strong> is a software architecture style consisting of guidelines and best practices for creating scalable web services. REST is a coordinated set of constraints applied to the design of components in a distributed hypermedia system that can lead to a more performant and maintainable architecture.    <cite>—— From <a href="http://en.wikipedia.org/wiki/Representational_state_transfer" target="_blank" rel="external">Wikipedia</a></cite></p>
</blockquote>
<p>也就是说：<strong>REST，它不是一种技术，也不是一种标准，而是一种网络资源访问模式，一种编程哲学</strong>。狭义上来说，REST指的是这样的设计思想：</p>
<ol>
<li>每一个 URI 代表一种资源</li>
<li>客户端和服务器之间，传递这种资源的某种表现层</li>
<li>客户端通过五个 HTTP 动词（GET，POST，PUT，PATCH，DELETE），对服务器端资源进行操作，实现”表现层状态转化”（State Transfer）</li>
</ol>
<p>狭义的 REST 范式是基于 B/S 架构，并使用 HTTP 协议进行数据交互。比起古老而笨重的 SOAP 等架构，这种模式更加轻便、直观，使网络资源的访问变得简洁、优雅，也更加符合当今 Web 开发的需求。</p>
<h2 id="0x02_如何正确使用_REST"><strong>0x02 如何正确使用 REST</strong></h2><p>正如上面所说，REST 是基于 HTTP 协议的。它用 URI 来定义资源，并用 HTTP 请求来操作资源。然而，并不是说使用了 HTTP 协议即可称之为 REST——真正意义上的 REST，有自己的一套准则。也正是这套准则，才使得 REST 简洁、优雅。</p>
<h3 id="REST_是语义的">REST 是语义的</h3><p>语义的（Semantic）是指：<strong>资源的 URI 或是资源的访问必须是有意义的，符合或尽量符合自然语言的规范</strong>。</p>
<p>举个例子：如果我要访问订单的列表，那么一个良好的 URI 定义应该是这样的：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="request">GET <span class="string">/orders/</span> HTTP/1.1</span></span><br></pre></td></tr></table></figure>
<p>资源的 URI 通常由名词组成，这也正符合自然语言的规范——表达一个物体，人们使用名词。</p>
<p>如果要精确定位某一个资源，通常需要进一步限制资源：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="request">GET <span class="string">/orders/1/</span> HTTP/1.1</span></span><br></pre></td></tr></table></figure>
<p>或是：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="request">GET <span class="string">/orders/current/</span> HTTP/1.1</span></span><br></pre></td></tr></table></figure>
<p>甚至，可以表示资源的从属关系：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="request">GET <span class="string">/users/current/orders/1/</span> HTTP/1.1</span></span><br></pre></td></tr></table></figure>
<p>这就像在和服务器对话一样：<strong>“请给我当前用户的第一份订单”</strong>。</p>
<p>而一些与资源本身无关的信息，比如列表的最大数目，可以放到 URI Params 中：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="request">GET <span class="string">/orders/?limit=20</span> HTTP/1.1</span></span><br></pre></td></tr></table></figure>
<p>HTTP协议中的动词（Verbs），通常用来描述对资源的操作。每一种动词都有它自己的意义：</p>
<ul>
<li><strong>GET</strong>——获取资源</li>
<li><strong>POST</strong>——建立一个新的资源</li>
<li><strong>PUT</strong>——修改一个资源，必须提交该资源的所有内容</li>
<li><strong>PATCH</strong>——修改一个资源，可以只提交该资源的一部分内容</li>
<li><strong>DELETE</strong>——删除一个资源</li>
</ul>
<h3 id="REST_是多样的">REST 是多样的</h3><p>至于返回的数据，服务器端可以提供多种格式供客户端选择，如 JSON、XML、YAML等等，通常用格式的缩写作为尾缀：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="request">GET <span class="string">/orders.json/</span> HTTP/1.1</span></span><br></pre></td></tr></table></figure>
<h3 id="REST_是健壮的">REST 是健壮的</h3><p>倘若用户请求的资源不存在或是提交的数据不合规范，服务器必须以<strong>HTTP状态码</strong>的方式通知客户端。常用的状态码有：</p>
<ul>
<li><strong>400</strong> 请求参数有误</li>
<li><strong>401</strong> 用户未登录</li>
<li><strong>403</strong> 没有权限</li>
<li><strong>404</strong> 资源找不到</li>
</ul>
<h2 id="0x03_django_中的_REST"><strong>0x03 django 中的 REST</strong></h2><p>像 REST 这么高大上的东西，早就有人对它进行了实现，这便是：<a href="http://www.django-rest-framework.org/" target="_blank" rel="external">Django Rest Framework</a>。基本的用法可以参见官网。</p>
<p>成熟的框架并不是最好的，只有适合自己的才是。在使用过程中我遇到了一系列的问题，并以自己的方式解决了他们。</p>
<h3 id="ViewSet_的路由不够_D-R-Y-">ViewSet 的路由不够 D.R.Y.</h3><p><code>ViewSet</code> 是 <code>rest_framework</code>中一个十分有创意的地方。它将 CRUD 操作集中到了一个类中，提高了代码的复用性。然而，每一个 <code>ViewSet</code> 都需要 定义一个 <code>Router</code> 进行 URL 路由，这很麻烦。于是乎我便想：</p>
<blockquote>
<p>要是能让它自动感知<code>ViewSet</code>的存在并自动为其定义路由，就像<code>django</code>中的<code>Models</code>一样，那该多好啊</p>
</blockquote>
<p>于是，我仿照<code>django.apps.registry</code>，写了一个能在启东时探知一个 app 中固定内容的 <code>app_cache</code> 模块：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app_cache/core.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.utils.importlib <span class="keyword">import</span> import_module</span><br><span class="line"><span class="keyword">from</span> django.utils.module_loading <span class="keyword">import</span> module_has_submodule</span><br><span class="line"><span class="keyword">from</span> django.apps <span class="keyword">import</span> apps</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppCache</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">'''</span><br><span class="line">    Inherit this class and override the fields below, then import and instantiate</span><br><span class="line">    the subclass at AppConfig.ready method.</span><br><span class="line">    '''</span></span><br><span class="line"></span><br><span class="line">    module_name = <span class="string">''</span></span><br><span class="line">    object_name = <span class="string">''</span></span><br><span class="line">    default_object = <span class="string">''</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        self.__module_name = <span class="string">'.%s'</span> % self.module_name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_objects</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> mod <span class="keyword">in</span> self.get_modules():</span><br><span class="line">            <span class="keyword">yield</span> getattr(mod, self.object_name, self.default_object)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_modules</span><span class="params">(self)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> app_config <span class="keyword">in</span> apps.get_app_configs():</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> module_has_submodule(app_config.module, self.module_name):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">yield</span> import_module(self.__module_name, app_config.name)</span><br></pre></td></tr></table></figure>
<p>同时新建一个叫<code>api</code>的 app，在<code>api/core.py</code>中实现自动寻找<code>ViewSet</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app_cache <span class="keyword">import</span> AppCache</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APICache</span><span class="params">(AppCache)</span>:</span></span><br><span class="line"></span><br><span class="line">    default_object = ()</span><br><span class="line">    object_name = <span class="string">'routers'</span></span><br><span class="line">    module_name = <span class="string">'routers'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_routers</span><span class="params">(self)</span>:</span></span><br><span class="line">        results = []</span><br><span class="line">        <span class="keyword">for</span> obj <span class="keyword">in</span> self.get_objects():</span><br><span class="line">            results.extend(obj)</span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line">cache = APICache()</span><br></pre></td></tr></table></figure>
<p>在<code>api/urls.py</code>中实现自动路由：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># api/urls.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url, patterns, include</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> ViewSetMixin</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .core <span class="keyword">import</span> cache</span><br><span class="line"></span><br><span class="line">extra_list = []</span><br><span class="line">router = DefaultRouter()</span><br><span class="line"><span class="keyword">for</span> pattern, obj <span class="keyword">in</span> cache.get_routers():</span><br><span class="line">    <span class="keyword">if</span> callable(obj) <span class="keyword">and</span> <span class="keyword">not</span> isinstance(obj, type) <span class="keyword">or</span> isinstance(obj, basestring):</span><br><span class="line">        extra_list.append(url(pattern, obj))</span><br><span class="line">    <span class="keyword">elif</span> issubclass(obj, ViewSetMixin):</span><br><span class="line">        router.register(pattern, obj)</span><br><span class="line">    <span class="keyword">elif</span> issubclass(obj, APIView):</span><br><span class="line">        extra_list.append(url(pattern, obj.as_view()))</span><br><span class="line"></span><br><span class="line">extra_list.append(url(<span class="string">r'^'</span>, include(router.urls)))</span><br><span class="line"></span><br><span class="line">urlpatterns = patterns(<span class="string">''</span>,</span><br><span class="line">    url(<span class="string">r'^auth/'</span>, include(<span class="string">'rest_framework.urls'</span>, namespace = <span class="string">'rest_framework'</span>)),</span><br><span class="line">    url(<span class="string">r'^root/$'</span>, <span class="string">'api.views.root'</span>,),</span><br><span class="line">    *extra_list</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>之后，只需在每个 app 中定义一个<code>routers.py</code>，并定义<code>routers</code>变量即可实现 <code>ViewSet</code> 的自动路由，例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> UserAPIViewSet</span><br><span class="line"></span><br><span class="line">routers = (</span><br><span class="line">    (<span class="string">r'users'</span>, UserAPIViewSet),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>非常方便。</p>
<h3 id="分页机制的进一步改进">分页机制的进一步改进</h3><p><code>rest_framework</code>提供了一个数据分页的机制：透过<code>limit</code>和<code>page</code>这两个 URL 参数可以实现数据的分页以及页码索引。</p>
<p>但这个功能在客户要求的应用场景中似乎并不太实用。毕竟，模联大会是一次节奏紧张的活动，网站并发量大，内容更新频繁，若应用传统分页的构想，可能会出现翻页时浏览到重复内容的情况。除此之外，这样的架构不利于实现<strong>瀑布流式</strong>的界面，因为瀑布流式要求待加载的数据与已加载的数据完美地无缝接合，而这一点对于传统分页架构来说也是力不从心。</p>
<p>曾记得，<a href="http://open.weibo.com/wiki/2/statuses/public_timeline" target="_blank" rel="external">新浪微博 API </a>中好像有类似的实现：凡是返回一个列表的 API ，返回数据中都会有<code>previous_cursor</code>和<code>next_cursor</code>两个参数，通过这两个参数，开发者可以获取上一份或下一份的数据。受此启发，我决定增强一下<code>rest_framework</code>的分页机制。</p>
<blockquote>
<p>####想法</p>
<ol>
<li>可在 API 的请求中传入参数 <code>sinceid</code> 或是 <code>beforeid</code>，表示获取<code>id</code>紧跟着<code>&lt;sinceid&gt;</code>或是<code>&lt;beforeid&gt;</code>的一批数据。</li>
<li>当 API 返回值是一个列表时，返回数据中增加两个域<code>since</code>和<code>before</code>，分别是指向上一批数据及下一批数据的 URL。</li>
</ol>
</blockquote>
<p>改动得不多，于是我便直接在别人的代码里开刀了。</p>
<p>首先在<code>rest_framework/</code>中增加一个<code>custom_filters.py</code>，用于存放自定义的过滤器：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django_filters <span class="keyword">import</span> FilterSet, NumberFilter</span><br><span class="line"></span><br><span class="line">__all__ = [<span class="string">'get_timeline_filter'</span>, <span class="string">'is_timeline_filter'</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimelineFilter</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_timeline_filter</span><span class="params">(obj)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> issubclass(obj.__class__, TimelineFilter)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_timeline_filter</span><span class="params">(model_class, base_filter_class = FilterSet)</span>:</span></span><br><span class="line">    <span class="string">"""</span><br><span class="line">    工厂方法，给不同的模型类指派不同的过滤器</span><br><span class="line">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> base_filter_class:</span><br><span class="line">        base_filter_class = FilterSet</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">_TimelineFilter</span><span class="params">(base_filter_class, TimelineFilter)</span>:</span></span><br><span class="line"></span><br><span class="line">        sinceid = NumberFilter(name = <span class="string">'pk'</span>, lookup_type = <span class="string">'gt'</span>)</span><br><span class="line">        beforeid = NumberFilter(name = <span class="string">'pk'</span>, lookup_type = <span class="string">'lt'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Meta</span><span class="params">(getattr<span class="params">(base_filter_class,<span class="string">'Meta'</span>,object)</span>)</span>:</span></span><br><span class="line">            model = model_class</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _TimelineFilter</span><br></pre></td></tr></table></figure>
<p>修改<code>rest_framework/generics.py</code>，为<code>GenericAPIView</code>加入<code>hack_filter_class()</code>方法，放入上面定义的过滤器；再修改<code>get_filter_backends()</code>方法，使其生效：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .custom_filters <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#...</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericAPIView</span><span class="params">(views.APIView)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hack_filter_class</span><span class="params">(self)</span>:</span></span><br><span class="line">        filter_class = getattr(self, <span class="string">'filter_class'</span>, <span class="keyword">None</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> is_timeline_filter(filter_class):</span><br><span class="line">            self.filter_class = get_timeline_filter(self.model, filter_class)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_filter_backends</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        Returns the list of filter backends that this view requires.</span><br><span class="line">        """</span></span><br><span class="line">        <span class="keyword">if</span> self.is_timeline:</span><br><span class="line">            self.hack_filter_class()</span><br><span class="line"></span><br><span class="line">        filter_backends = self.filter_backends <span class="keyword">or</span> []</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> filter_backends <span class="keyword">and</span> self.filter_backend:</span><br><span class="line">            warnings.warn(</span><br><span class="line">                <span class="string">'The `filter_backend` attribute and `FILTER_BACKEND` setting '</span></span><br><span class="line">                <span class="string">'are due to be deprecated in favor of a `filter_backends` '</span></span><br><span class="line">                <span class="string">'attribute and `DEFAULT_FILTER_BACKENDS` setting, that take '</span></span><br><span class="line">                <span class="string">'a *list* of filter backend classes.'</span>,</span><br><span class="line">                PendingDeprecationWarning, stacklevel=<span class="number">2</span></span><br><span class="line">            )</span><br><span class="line">            filter_backends = [self.filter_backend]</span><br><span class="line">        <span class="keyword">return</span> filter_backends</span><br></pre></td></tr></table></figure>
<p>最后再修改<code>rest_framework/pagination.py</code>，这个模块的功能是给<code>Serializer</code>加入分页机制中一些必要的域，如<code>next</code>和<code>previous</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line">sinceid_field = <span class="string">'sinceid'</span></span><br><span class="line">beforeid_field = <span class="string">'beforeid'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SinceIdField</span><span class="params">(serializers.Field)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_native</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            value.object_list = value.object_list[:]</span><br><span class="line">            sinceid = max(obj.id <span class="keyword">for</span> obj <span class="keyword">in</span> value.object_list) </span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">        request = self.context.get(<span class="string">'request'</span>)</span><br><span class="line">        url = request <span class="keyword">and</span> request.build_absolute_uri() <span class="keyword">or</span> <span class="string">''</span></span><br><span class="line">        <span class="keyword">return</span> replace_query_params(url, **&#123;</span><br><span class="line">            sinceid_field: sinceid,</span><br><span class="line">            beforeid_field: <span class="string">''</span></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BeforeIdField</span><span class="params">(serializers.Field)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_native</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            value.object_list = value.object_list[:]</span><br><span class="line">            beforeid = min(obj.id <span class="keyword">for</span> obj <span class="keyword">in</span> value.object_list) </span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">        request = self.context.get(<span class="string">'request'</span>)</span><br><span class="line">        url = request <span class="keyword">and</span> request.build_absolute_uri() <span class="keyword">or</span> <span class="string">''</span></span><br><span class="line">        <span class="keyword">return</span> replace_query_params(url, **&#123;</span><br><span class="line">            beforeid_field: beforeid,</span><br><span class="line">            sinceid_field: <span class="string">''</span></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaginationSerializer</span><span class="params">(BasePaginationSerializer)</span>:</span></span><br><span class="line"></span><br><span class="line">    count = serializers.Field(source=<span class="string">'paginator.count'</span>)</span><br><span class="line">    next = NextPageField(source=<span class="string">'*'</span>)</span><br><span class="line">    previous = PreviousPageField(source=<span class="string">'*'</span>)</span><br><span class="line">    before = BeforeIdField(source=<span class="string">'*'</span>)</span><br><span class="line">    since = SinceIdField(source=<span class="string">'*'</span>)</span><br></pre></td></tr></table></figure>
<p>完成了——在没有修改一处业务逻辑代码的前提下，我增强了分页机制。</p>
<h2 id="0x04_前端接口"><strong>0x04 前端接口</strong></h2><p>终于来到前端部分了。</p>
</div><div class="tags"><a href="/tags/HFMUN重构系列/">HFMUN重构系列</a></div><div class="post-nav"><a href="/that-starry-night/" class="pre"><i class="icon-previous">那一年，我们望向星空</i></a><a href="/chemistry-impurity/" class="next">高中化学常用除杂方法<i class="icon-next"></i></a></div><div data-thread-key="/hfmun-reconstruction-4/" data-title="【HFMUN重构系列】4. Restful API 框架" data-url="http://hsfzxjy.github.io//hfmun-reconstruction-4/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="/hfmun-reconstruction-4/" data-title="【HFMUN重构系列】4. Restful API 框架" data-url="http://hsfzxjy.github.io//hfmun-reconstruction-4/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><div id="search"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://hsfzxjy.github.io"></form></div></div><div class="widget"><div class="widget-title">导航<ul><li><a href="/archives/"> <i class="icon-archives"> 归档</i></a></li><li><a href="/works/"> <i class="icon-works"> 个人作品</i></a></li><li><a href="/atom.xml"> <i class="icon-rss"> 订阅</i></a></li></ul></div></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/学习/">学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数学/">数学</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂感/">杂感</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/转载文章/">转载文章</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/随手记/">随手记</a></li></ul></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/创新作文大赛/" style="font-size: 15px;">创新作文大赛</a> <a href="/tags/Delphi/" style="font-size: 15px;">Delphi</a> <a href="/tags/mongodb/" style="font-size: 15px;">mongodb</a> <a href="/tags/node-js/" style="font-size: 15px;">node.js</a> <a href="/tags/express-js/" style="font-size: 15px;">express.js</a> <a href="/tags/家书/" style="font-size: 15px;">家书</a> <a href="/tags/杂感/" style="font-size: 15px;">杂感</a> <a href="/tags/成人礼/" style="font-size: 15px;">成人礼</a> <a href="/tags/产品/" style="font-size: 15px;">产品</a> <a href="/tags/编程/" style="font-size: 15px;">编程</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/web设计/" style="font-size: 15px;">web设计</a> <a href="/tags/wisecity/" style="font-size: 15px;">wisecity</a> <a href="/tags/前端自动化测试，总结/" style="font-size: 15px;">前端自动化测试，总结</a> <a href="/tags/前端/" style="font-size: 15px;">前端</a> <a href="/tags/单元测试/" style="font-size: 15px;">单元测试</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/不经意间的感动/" style="font-size: 15px;">不经意间的感动</a> <a href="/tags/HFMUN重构系列/" style="font-size: 15px;">HFMUN重构系列</a> <a href="/tags/化学/" style="font-size: 15px;">化学</a> <a href="/tags/ubuntu/" style="font-size: 15px;">ubuntu</a> <a href="/tags/apt-get/" style="font-size: 15px;">apt-get</a> <a href="/tags/物理/" style="font-size: 15px;">物理</a> <a href="/tags/OOP/" style="font-size: 15px;">OOP</a> <a href="/tags/Sublime/" style="font-size: 15px;">Sublime</a> <a href="/tags/转载/" style="font-size: 15px;">转载</a> <a href="/tags/字体/" style="font-size: 15px;">字体</a> <a href="/tags/百题大过关/" style="font-size: 15px;">百题大过关</a> <a href="/tags/逆袭/" style="font-size: 15px;">逆袭</a> <a href="/tags/MySql/" style="font-size: 15px;">MySql</a> <a href="/tags/NOIP2014/" style="font-size: 15px;">NOIP2014</a> <a href="/tags/信息学竞赛/" style="font-size: 15px;">信息学竞赛</a> <a href="/tags/北大金秋营/" style="font-size: 15px;">北大金秋营</a> <a href="/tags/树状数组/" style="font-size: 15px;">树状数组</a> <a href="/tags/LCA/" style="font-size: 15px;">LCA</a> <a href="/tags/归并排序/" style="font-size: 15px;">归并排序</a> <a href="/tags/逆序对/" style="font-size: 15px;">逆序对</a> <a href="/tags/最小生成树/" style="font-size: 15px;">最小生成树</a> <a href="/tags/数论/" style="font-size: 15px;">数论</a> <a href="/tags/数学/" style="font-size: 15px;">数学</a> <a href="/tags/数列/" style="font-size: 15px;">数列</a> <a href="/tags/高精度/" style="font-size: 15px;">高精度</a> <a href="/tags/UVa/" style="font-size: 15px;">UVa</a> <a href="/tags/Pascal/" style="font-size: 15px;">Pascal</a> <a href="/tags/搜索/" style="font-size: 15px;">搜索</a> <a href="/tags/剪枝/" style="font-size: 15px;">剪枝</a> <a href="/tags/浮点数/" style="font-size: 15px;">浮点数</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/游记/" style="font-size: 15px;">游记</a> <a href="/tags/win32/" style="font-size: 15px;">win32</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/md5-cracker-powered-by-nodejs/">初试 node.js：MD5 解密网站</a></li><li class="post-list-item"><a class="post-list-link" href="/letter-to-parents/">家书·十八岁成人礼</a></li><li class="post-list-item"><a class="post-list-link" href="/hobby-or-needs/">炫技？还是需求？</a></li><li class="post-list-item"><a class="post-list-link" href="/the-state-of-responsive-images-in-2015/">【译】响应式图片的现状</a></li><li class="post-list-item"><a class="post-list-link" href="/why-are-so-many-programming-languages/">【译】“为什么有这么多的编程语言？”</a></li><li class="post-list-item"><a class="post-list-link" href="/wisecity-conclusion/">Wisecity 商赛总结——也谈前端自动化测试</a></li><li class="post-list-item"><a class="post-list-link" href="/how-to-fuck-a-bilk-site/">记一次 DoS 诈骗网站的经历</a></li><li class="post-list-item"><a class="post-list-link" href="/secret/">不能说的秘密</a></li><li class="post-list-item"><a class="post-list-link" href="/that-starry-night/">那一年，我们望向星空</a></li><li class="post-list-item"><a class="post-list-link" href="/hfmun-reconstruction-4/">【HFMUN重构系列】4. Restful API 框架</a></li></ul></div><div class="widget"><div class="comments-title">最近评论</div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div></div></div></div><div id="footer">© <a href="/" rel="nofollow">hsfzxjy.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></body><script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/totop.js" type="text/javascript"></script><script src="/js/fancybox.pack.js" type="text/javascript"></script><link rel="stylesheet" href="/css/jquery.fancybox.css" type="text/css"><script>$(document).ready(function() {
  $('img').each(function() {
    if ($(this).parent().hasClass('fancybox')) return;
    if ($(this).hasClass('nofancybox')) return;
    var alt = this.alt;
    if (alt) $(this).after('<span class="caption">' + alt + '</span>');
    $(this).wrap('<a href="' + ($(this).attr('data-src') == null ? this.src : $(this).attr('data-src')) + '" title="' + alt + '" class="fancybox"></a>');
  });
  $(this).find('.fancybox').each(function(){
    $(this).attr('rel', 'article');
  });
});</script><script>$(document).ready(function() {
  $("a[href$='.jpg'],a[href$='.png'],a[href$='.gif']").attr('rel', 'gallery').fancybox({
   helpers : {
   title: { type: 'inside'}
   }
 });
});
</script><script>var duoshuoQuery = {short_name:'hsfzxjy'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$']]},
  jax: ["input/TeX","output/HTML-CSS"]
});
</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></html>